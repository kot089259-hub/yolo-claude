<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ëá™ÂãïÂ≠óÂπï„ÉÑ„Éº„É´</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Serif+JP:wght@400;700&family=M+PLUS+1p:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Kosugi+Maru&family=Sawarabi+Gothic&family=Sawarabi+Mincho&family=Zen+Kaku+Gothic+New:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&family=Zen+Old+Mincho:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Kiwi+Maru:wght@400;700&family=Hachi+Maru+Pop&family=Yusei+Magic&family=Dela+Gothic+One&family=Reggae+One&family=RocknRoll+One&family=Stick&family=DotGothic16&family=Potta+One&family=Rampart+One&family=Train+One&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Lato:wght@400;700&family=Inter:wght@400;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/umd/ffmpeg.min.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js" async></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fc;
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(0, 0, 0, 0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(0, 0, 0, 0.04) 0%, transparent 50%);
      color: #1a1a2e;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #222222, #222222, #222222);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 36px;
      font-size: 13px;
      font-weight: 400;
    }

    /* Upload Area */
    .upload-area {
      border: 1.5px dashed #cbd5e1;
      border-radius: 16px;
      padding: 52px 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .upload-icon {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.7;
    }

    .upload-text {
      font-size: 15px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 6px;
    }

    .upload-hint {
      font-size: 12px;
      color: #94a3b8;
    }

    .upload-area input[type="file"] {
      display: none;
    }

    /* Progress */
    .progress-section {
      margin-top: 28px;
      display: none;
    }

    .progress-section.active {
      display: block;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.85);
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
      backdrop-filter: blur(20px);
    }

    .step.active {
      background: rgba(0, 0, 0, 0.04);
      border-color: rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.04);
    }

    .step.done {
      background: rgba(16, 185, 129, 0.06);
      border-color: rgba(0, 0, 0, 0.25);
    }

    .step.error {
      background: rgba(239, 68, 68, 0.06);
      border-color: rgba(239, 68, 68, 0.25);
    }

    .step-icon {
      font-size: 20px;
      width: 32px;
      text-align: center;
    }

    .step-text {
      flex: 1;
    }

    .step-title {
      font-weight: 600;
      font-size: 13px;
      color: #334155;
    }

    .step-detail {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .step-progress {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      margin-top: 6px;
      overflow: hidden;
    }

    .step-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #222222, #444444);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .step-stats {
      font-size: 10px;
      color: #64748b;
      margin-top: 3px;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #444444;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Result */
    .result-section {
      margin-top: 28px;
      display: none;
    }

    .result-section.active {
      display: block;
    }

    .result-card {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      backdrop-filter: blur(20px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.02);
    }

    .result-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 14px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subtitle-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .subtitle-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid rgba(241, 245, 249, 0.8);
      font-size: 13px;
    }

    .subtitle-item .sub-index {
      color: #94a3b8;
      font-size: 11px;
      min-width: 22px;
      text-align: center;
      font-weight: 500;
    }

    .subtitle-item input[type="text"] {
      flex: 1;
      min-width: 0;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #1e293b;
      padding: 7px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .subtitle-item input[type="text"]:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
    }

    .subtitle-item input[type="number"] {
      width: 54px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .subtitle-item input[type="number"]:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
    }

    .seg-pos {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .seg-pos-label {
      font-size: 10px;
      color: #94a3b8;
    }

    .seg-pos input {
      width: 38px !important;
      font-size: 10px !important;
      padding: 5px 2px !important;
      color: #222222 !important;
    }

    .btn-style-toggle {
      background: rgba(0, 0, 0, 0.1);
      color: #222222;
    }

    .btn-style-toggle:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .seg-style-row {
      display: none;
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 10px;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: -2px 0 4px 22px;
    }

    .seg-style-row.open {
      display: flex;
    }

    .seg-style-row label {
      font-size: 10px;
      color: #94a3b8;
      margin-right: 2px;
    }

    .seg-style-row select {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      color: #1e293b;
      padding: 4px 6px;
      font-size: 11px;
      max-width: 120px;
    }

    .seg-style-row input[type="number"] {
      width: 42px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      color: #1e293b;
      padding: 4px 4px;
      font-size: 11px;
      text-align: center;
    }

    .seg-style-row input[type="color"] {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
      padding: 0;
    }

    .seg-style-row .seg-field {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    /* ‚îÄ‚îÄ Section Cards (shared) ‚îÄ‚îÄ */
    .audio-card,
    .edit-card,
    .visual-card,
    .telop-card,
    .export-card,
    .style-card {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      margin-top: 12px;
      backdrop-filter: blur(20px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.02);
    }

    /* Section titles ‚Äî unified muted style */
    .audio-title,
    .edit-title,
    .visual-title,
    .visual-title.overlay,
    .visual-title.filter,
    .visual-title.kenburns,
    .telop-title,
    .export-title,
    .style-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 14px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Audio Tracks */
    .audio-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid rgba(241, 245, 249, 0.8);
      font-size: 12px;
    }

    .audio-item .audio-name {
      flex: 1;
      color: #64748b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .audio-item input[type="number"] {
      width: 52px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 5px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .audio-item label {
      font-size: 10px;
      color: #94a3b8;
    }

    .audio-upload-btn {
      background: rgba(0, 0, 0, 0.05);
      color: #222222;
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .audio-upload-btn:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    /* Edit Section */
    .edit-section {
      margin-bottom: 18px;
    }

    .edit-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .edit-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .edit-field {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .edit-field label {
      font-size: 11px;
      color: #94a3b8;
    }

    .edit-field input[type="number"],
    .edit-field select {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      width: 66px;
      text-align: center;
    }

    .edit-field input:focus,
    .edit-field select:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
    }

    .edit-hint {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .merge-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(241, 245, 249, 0.8);
      font-size: 12px;
    }

    .merge-item .merge-name {
      flex: 1;
      color: #64748b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .merge-upload-btn {
      background: rgba(0, 0, 0, 0.05);
      color: #222222;
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .merge-upload-btn:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .speed-presets {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }

    .speed-preset-btn {
      padding: 5px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.85);
      color: #94a3b8;
      font-size: 11px;
      cursor: pointer;
      font-family: 'SF Mono', 'Fira Code', monospace;
      transition: all 0.2s;
    }

    .speed-preset-btn:hover {
      border-color: #222222;
      color: #222222;
    }

    .speed-preset-btn.active {
      background: linear-gradient(135deg, #222222, #111111);
      color: #fff;
      border-color: #222222;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
    }

    /* Filter / Color */
    .filter-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .filter-item label {
      font-size: 11px;
      color: #64748b;
      display: flex;
      justify-content: space-between;
    }

    .filter-item label span {
      color: #222222;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 10px;
    }

    .filter-item input[type="range"] {
      width: 100%;
      accent-color: #222222;
      height: 4px;
    }

    .overlay-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid rgba(241, 245, 249, 0.8);
      font-size: 12px;
      flex-wrap: wrap;
    }

    .overlay-item .overlay-name {
      color: #222222;
      min-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .overlay-item input[type="number"],
    .overlay-item select {
      width: 48px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      color: #1e293b;
      padding: 4px 3px;
      font-size: 10px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .overlay-item label {
      font-size: 10px;
      color: #94a3b8;
    }

    .overlay-upload-btn {
      background: rgba(0, 0, 0, 0.05);
      color: #222222;
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .overlay-upload-btn:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .kb-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .kb-field {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kb-field label {
      font-size: 11px;
      color: #94a3b8;
      min-width: 38px;
    }

    .kb-field input {
      width: 58px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .kb-field input:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
    }

    .btn-reset {
      background: rgba(241, 245, 249, 0.8);
      color: #94a3b8;
      border: 1px solid #cbd5e1;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
    }

    .btn-reset:hover {
      color: #222222;
      border-color: #222222;
    }

    /* Telop */
    .telop-item {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 6px;
    }

    .telop-top {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .telop-top input[type="text"] {
      flex: 1;
      min-width: 120px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .telop-top input[type="text"]:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
    }

    .telop-top input[type="number"] {
      width: 52px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #1e293b;
      padding: 5px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .telop-top label {
      font-size: 10px;
      color: #94a3b8;
    }

    .telop-style {
      display: none;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e2e8f0;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .telop-style.open {
      display: flex;
    }

    .telop-style select,
    .telop-style input[type="number"] {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      color: #1e293b;
      padding: 4px 6px;
      font-size: 11px;
    }

    .telop-style select {
      max-width: 110px;
    }

    .telop-style input[type="number"] {
      width: 40px;
      text-align: center;
    }

    .telop-style input[type="color"] {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
      padding: 0;
    }

    .telop-style label {
      font-size: 10px;
      color: #94a3b8;
    }

    .telop-style .tsf {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .telop-add-btn {
      background: rgba(0, 0, 0, 0.05);
      color: #222222;
      width: 100%;
      height: 36px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
    }

    .telop-add-btn:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    /* Export Section */
    .export-section {
      margin-bottom: 18px;
    }

    .export-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
      border: none;
    }

    .export-btn.render {
      background: linear-gradient(135deg, #222222, #111111);
      color: white;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .export-btn.render:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(-1px);
    }

    .export-btn.render:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .export-btn.sub {
      background: rgba(0, 0, 0, 0.1);
      color: #222222;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .export-btn.sub:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
    }

    .export-btn.thumb {
      background: rgba(0, 0, 0, 0.1);
      color: #222222;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    .export-btn.thumb:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
    }

    .export-field input[type="number"] {
      width: 60px;
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .export-field label {
      font-size: 11px;
      color: #94a3b8;
    }

    .export-field select {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #222222;
      padding: 7px 10px;
      font-size: 12px;
    }

    .export-field {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .render-status {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 8px;
    }

    .render-status.success {
      color: #222222;
    }

    .render-status.error {
      color: #ef4444;
    }

    .thumb-preview {
      margin-top: 10px;
      max-width: 300px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .thumb-preview img {
      width: 100%;
      display: block;
    }

    .download-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #222222;
      font-size: 12px;
      text-decoration: none;
      margin-top: 6px;
    }

    .download-link:hover {
      text-decoration: underline;
    }

    /* Utility Bar */
    .utility-bar {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 10px;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      backdrop-filter: blur(20px);
    }

    .utility-title {
      font-size: 12px;
      font-weight: 600;
      color: #94a3b8;
      margin-right: 6px;
    }

    .util-btn {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
      border: 1px solid #cbd5e1;
      background: rgba(255, 255, 255, 0.85);
      color: #64748b;
    }

    .util-btn:hover {
      color: #1e293b;
      border-color: #94a3b8;
    }

    .util-btn:disabled {
      opacity: 0.25;
      cursor: not-allowed;
    }

    .util-btn.undo,
    .util-btn.redo {
      color: #222222;
    }

    .util-btn.undo:hover,
    .util-btn.redo:hover {
      border-color: #222222;
    }

    .util-btn.project-save {
      color: #222222;
    }

    .util-btn.project-save:hover {
      border-color: #222222;
    }

    .util-btn.project-load {
      color: #222222;
    }

    .util-btn.project-load:hover {
      border-color: #222222;
    }

    .util-btn.shortcut-help {
      color: #222222;
    }

    .util-btn.shortcut-help:hover {
      border-color: #222222;
    }

    .util-sep {
      width: 1px;
      height: 20px;
      background: #e2e8f0;
      margin: 0 2px;
    }

    .undo-count {
      font-size: 10px;
      color: #94a3b8;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .shortcut-panel {
      display: none;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 14px 16px;
      margin-top: 6px;
      font-size: 11px;
    }

    .shortcut-panel.open {
      display: block;
    }

    .shortcut-panel table {
      width: 100%;
      border-collapse: collapse;
    }

    .shortcut-panel td {
      padding: 3px 8px;
      border-bottom: 1px solid rgba(241, 245, 249, 0.8);
    }

    .shortcut-panel td:first-child {
      color: #222222;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-weight: 600;
      white-space: nowrap;
    }

    .shortcut-panel td:last-child {
      color: #94a3b8;
    }

    .time-sep {
      color: #94a3b8;
      font-size: 11px;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .btn-delete {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .btn-add {
      background: rgba(0, 0, 0, 0.05);
      color: #222222;
      width: 100%;
      height: 34px;
      border-radius: 8px;
      border: 1px dashed #cbd5e1;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: all 0.2s;
    }

    .btn-add:hover {
      border-color: #222222;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .save-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, #222222, #111111);
      color: #fff;
      padding: 10px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 13px;
      transition: transform 0.25s ease;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .save-toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .btn-save {
      background: linear-gradient(135deg, #222222, #111111);
      color: white;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-save:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(-1px);
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .btn {
      padding: 10px 22px;
      border-radius: 10px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #222222, #111111);
      color: white;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(241, 245, 249, 0.8);
      color: #64748b;
      border: 1px solid #cbd5e1;
    }

    .btn-secondary:hover {
      background: rgba(241, 245, 249, 1);
      color: #1e293b;
    }

    .error-msg {
      color: #ef4444;
      text-align: center;
      margin-top: 14px;
      font-size: 13px;
    }

    /* Video Preview */
    .video-preview {
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: relative;
    }

    .video-preview video {
      width: 100%;
      max-height: 380px;
      display: block;
    }

    /* Subtitle Overlay on Video */
    .subtitle-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 40px;
      /* controls area */
      pointer-events: none;
      z-index: 10;
    }

    .subtitle-overlay .sub-line {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      max-width: 90%;
      text-align: center;
      padding: 4px 12px;
      border-radius: 4px;
      font-family: 'Noto Sans JP', sans-serif;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.4;
      transition: opacity 0.2s;
    }

    .subtitle-overlay .sub-line.bottom {
      bottom: 8%;
    }

    .subtitle-overlay .sub-line.top {
      top: 8%;
    }

    .subtitle-overlay .sub-line.center {
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .subtitle-overlay .telop-line {
      position: absolute;
      pointer-events: none;
      white-space: pre-wrap;
      word-break: break-word;
      padding: 3px 8px;
      border-radius: 4px;
      transition: opacity 0.2s;
    }

    /* Style Settings */
    .style-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .style-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .style-field label {
      font-size: 11px;
      color: #64748b;
      font-weight: 600;
    }

    .style-field select,
    .style-field input[type="number"] {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #1e293b;
      padding: 8px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .style-field select:focus,
    .style-field input[type="number"]:focus {
      outline: none;
      border-color: #222222;
      background: rgba(0, 0, 0, 0.04);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-row input[type="color"] {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: transparent;
    }

    .color-row .color-hex {
      background: rgba(241, 245, 249, 0.8);
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #1e293b;
      padding: 8px 10px;
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      width: 95px;
    }

    .pos-buttons {
      display: flex;
      gap: 3px;
    }

    .pos-btn {
      flex: 1;
      padding: 8px 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.85);
      color: #64748b;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
    }

    .pos-btn.active {
      background: linear-gradient(135deg, #222222, #111111);
      color: white;
      border-color: #222222;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
    }

    .pos-btn:hover:not(.active) {
      border-color: #94a3b8;
    }

    .style-preview {
      margin-top: 14px;
      background: #f1f5f9;
      border-radius: 10px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .style-preview-text {
      padding: 6px 16px;
      border-radius: 8px;
      text-align: center;
      transition: all 0.15s;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle {
      width: 40px;
      height: 22px;
      border-radius: 11px;
      background: #cbd5e1;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }

    .toggle.active {
      background: linear-gradient(135deg, #222222, #111111);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }

    .toggle.active::after {
      transform: translateX(18px);
    }

    /* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
    .tab-nav {
      display: flex;
      gap: 2px;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(20px);
    }

    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      border: none;
      border-radius: 9px;
      background: transparent;
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: #334155;
      background: rgba(241, 245, 249, 0.8);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #222222, #111111);
      color: #fff;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .tab-btn .tab-icon {
      font-size: 14px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Responsive ‚Äî Tablet (‚â§768px)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    @media (max-width: 768px) {
      .container {
        padding: 32px 16px 60px;
      }

      h1 {
        font-size: 20px;
      }

      /* Grids ‚Üí single column */
      .style-grid,
      .filter-grid,
      .kb-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .style-field[style*="grid-column"] {
        grid-column: auto !important;
      }

      /* Subtitle items ‚Äî stack vertically */
      .subtitle-item {
        flex-wrap: wrap;
        gap: 6px;
        padding: 10px 0;
      }

      .subtitle-item input[type="text"] {
        flex-basis: 100%;
        order: 2;
      }

      .subtitle-item .sub-index {
        order: 0;
      }

      /* Edit fields */
      .edit-row {
        gap: 8px;
      }

      /* Actions ‚Äî stack buttons on tablet */
      .actions {
        flex-wrap: wrap;
      }

      .actions .btn {
        flex: 1;
        min-width: 120px;
      }

      /* Utility bar scroll */
      .utility-bar {
        gap: 4px;
        padding: 10px 12px;
      }

      /* Export buttons wider */
      .export-btn {
        padding: 10px 16px;
      }

      /* Speed presets wrap nicely */
      .speed-presets {
        flex-wrap: wrap;
      }

      /* Tab nav ‚Äî smaller on tablet */
      .tab-nav {
        gap: 1px;
        padding: 3px;
      }

      .tab-btn {
        padding: 8px 6px;
        font-size: 11px;
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Responsive ‚Äî Phone (‚â§480px)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    @media (max-width: 480px) {
      .container {
        padding: 24px 12px 48px;
      }

      h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 12px;
        margin-bottom: 24px;
      }

      /* Upload area smaller */
      .upload-area {
        padding: 36px 16px;
      }

      .upload-icon {
        font-size: 28px;
        margin-bottom: 8px;
      }

      .upload-text {
        font-size: 14px;
      }

      .upload-hint {
        font-size: 11px;
      }

      /* Cards tighter */
      .audio-card,
      .edit-card,
      .visual-card,
      .telop-card,
      .export-card,
      .style-card,
      .result-card {
        padding: 14px;
      }

      /* Subtitle items fully stacked */
      .subtitle-item {
        font-size: 12px;
        padding: 8px 0;
      }

      .subtitle-item input[type="text"] {
        padding: 8px;
        font-size: 14px;
        /* bigger for mobile input */
      }

      .subtitle-item input[type="number"] {
        width: 48px;
        padding: 6px 2px;
        font-size: 12px;
      }

      /* Telop items */
      .telop-top {
        gap: 6px;
      }

      .telop-top input[type="text"] {
        font-size: 14px;
        padding: 8px;
      }

      /* Style fields ‚Äî bigger inputs for touch */
      .style-field select,
      .style-field input[type="number"] {
        padding: 10px;
        font-size: 14px;
      }

      .color-row input[type="color"] {
        width: 40px;
        height: 40px;
      }

      .color-row .color-hex {
        padding: 10px;
        font-size: 14px;
        width: 100px;
      }

      /* Position buttons bigger for touch */
      .pos-btn {
        padding: 10px 0;
        font-size: 13px;
      }

      /* Edit fields ‚Äî slightly bigger */
      .edit-field input[type="number"],
      .edit-field select {
        padding: 8px 6px;
        font-size: 13px;
        width: 60px;
      }

      .edit-field label {
        font-size: 12px;
      }

      /* Toggle bigger for touch */
      .toggle {
        width: 44px;
        height: 24px;
        border-radius: 12px;
      }

      .toggle::after {
        width: 18px;
        height: 18px;
      }

      .toggle.active::after {
        transform: translateX(20px);
      }

      /* Buttons bigger for touch */
      .btn {
        padding: 12px 20px;
        font-size: 14px;
        width: 100%;
      }

      .actions {
        flex-direction: column;
        gap: 8px;
      }

      .export-btn {
        padding: 12px 16px;
        font-size: 13px;
        width: 100%;
      }

      .export-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .export-field {
        width: 100%;
      }

      .export-field select {
        flex: 1;
      }

      /* Add/Upload buttons taller for touch */
      .btn-add,
      .audio-upload-btn,
      .overlay-upload-btn,
      .merge-upload-btn,
      .telop-add-btn {
        height: 40px;
        font-size: 13px;
      }

      /* Delete button bigger for touch */
      .btn-icon {
        width: 32px;
        height: 32px;
        font-size: 15px;
      }

      /* Utility bar ‚Äî scrollable */
      .utility-bar {
        padding: 10px;
        gap: 4px;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .util-btn {
        padding: 8px 10px;
        font-size: 11px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Shortcut panel */
      .shortcut-panel {
        padding: 10px 12px;
        font-size: 11px;
      }

      /* Video preview */
      .video-preview video {
        max-height: 240px;
      }

      /* Filter sliders ‚Äî slightly bigger */
      .filter-item input[type="range"] {
        height: 6px;
      }

      /* Ken Burns fields */
      .kb-field input {
        width: 52px;
        padding: 8px 4px;
        font-size: 13px;
      }

      /* Overlay items stack */
      .overlay-item {
        font-size: 11px;
        gap: 6px;
      }

      /* Speed presets */
      .speed-preset-btn {
        padding: 7px 10px;
        font-size: 12px;
      }

      /* Seg style row */
      .seg-style-row {
        margin-left: 0;
        padding: 8px;
      }

      /* Tab nav ‚Äî compact on phone */
      .tab-nav {
        padding: 3px;
        border-radius: 8px;
      }

      .tab-btn {
        padding: 8px 4px;
        font-size: 10px;
        flex-direction: column;
        gap: 2px;
      }

      .tab-btn .tab-icon {
        font-size: 16px;
      }

      /* Thumb preview full width */
      .thumb-preview {
        max-width: 100%;
      }

      /* Segment style fields ‚Äî stack and full width */
      .seg-field {
        min-width: 0;
      }

      .seg-field select,
      .seg-field input {
        font-size: 14px;
        padding: 8px;
      }

      /* Tab nav ‚Äî horizontal scroll */
      .tab-nav {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
      }

      .tab-btn {
        flex-shrink: 0;
        min-width: 0;
      }

      /* Video preview ‚Äî full height */
      .video-preview {
        border-radius: 0;
        margin-left: -12px;
        margin-right: -12px;
      }

      /* Subtitle overlay ‚Äî less bottom offset for mobile controls */
      .subtitle-overlay {
        bottom: 32px;
      }

      /* Fix iOS zoom on input focus */
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        font-size: 16px !important;
      }

      /* Progress steps ‚Äî compact */
      .step {
        padding: 10px;
      }

      .step-icon {
        font-size: 18px;
      }

      .step-title {
        font-size: 13px;
      }

      /* Export buttons stack */
      .export-btn {
        font-size: 14px;
        padding: 14px 16px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üé¨ ÂãïÁîªÁ∑®ÈõÜ„ÉÑ„Éº„É´</h1>
    <p class="subtitle">ÂãïÁîª„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Å®AI„ÅåËá™Âãï„ÅßÂ≠óÂπï„Çí„Å§„Åë„Åæ„Åô„ÄÅ„Åù„ÅÆ‰ªñÁ∞°Âçò„Å™Á∑®ÈõÜ„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ</p>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">ÂãïÁîª„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
      <div class="upload-hint">„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏ÊäûÔºà.mp4, .mov, .webmÔºâ</div>
      <input type="file" id="fileInput" accept="video/*">
    </div>

    <!-- ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ -->
    <div
      style="margin-top:16px;padding:14px 18px;background:rgba(255,255,255,0.85);border:1px solid #e2e8f0;border-radius:12px;font-size:13px;color:#64748b;line-height:1.7;">
      <strong style="color:#334155;">üìñ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</strong><br>
      ÂãïÁîª„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åü„ÇâAI„ÅåËá™Âãï„ÅßÊñáÂ≠óËµ∑„Åì„Åó„Åó„Å¶„Åè„Çå„Åæ„Åô„ÄÇAI„ÅÆÂ≠óÂπï„ÇíÁõ¥„Åó„Åü„ÅÑÂ†¥Âêà„ÇÑ„ÄÅËá™ÂàÜ„ÅßÂ≠óÂπï„ÇíÁ∑®ÈõÜ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØÂ≠óÂπï„ÅÆ„Çª„Ç∞„É°„É≥„ÉàÔºàÂå∫Âàá„ÇäÔºâ„Åî„Å®„Å´Á∑®ÈõÜ„ÅåÂèØËÉΩ„Åß„Åô„ÄÇÂá∫Âäõ„ÅØMP4„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Åß„Åç„Åæ„Åô„ÄÇ
    </div>

    <!-- Video Preview -->
    <div class="video-preview" id="videoPreview" style="display:none">
      <video id="previewVideo" controls></video>
      <div class="subtitle-overlay" id="subtitleOverlay"></div>
    </div>

    <!-- Progress -->
    <div class="progress-section" id="progressSection">
      <div class="step" id="stepCompress" style="display:none">
        <div class="step-icon">üì¶</div>
        <div class="step-text">
          <div class="step-title">ÂãïÁîª„ÇíÂúßÁ∏Æ‰∏≠...</div>
          <div class="step-detail" id="compressDetail"></div>
          <div class="step-progress" id="compressProgressBar">
            <div class="step-progress-fill" id="compressProgressFill"></div>
          </div>
          <div class="step-stats" id="compressStats"></div>
        </div>
      </div>
      <div class="step" id="stepUpload">
        <div class="step-icon">‚¨ÜÔ∏è</div>
        <div class="step-text">
          <div class="step-title">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</div>
          <div class="step-detail" id="uploadDetail"></div>
          <div class="step-progress" id="uploadProgressBar">
            <div class="step-progress-fill" id="uploadProgressFill"></div>
          </div>
          <div class="step-stats" id="uploadStats"></div>
        </div>
      </div>
      <div class="step" id="stepExtract">
        <div class="step-icon">üéµ</div>
        <div class="step-text">
          <div class="step-title">Èü≥Â£∞„ÇíÊäΩÂá∫‰∏≠...</div>
          <div class="step-detail">FFmpeg„ÅßÂãïÁîª„Åã„ÇâÈü≥Â£∞„ÇíÂàÜÈõ¢„Åó„Åæ„Åô</div>
        </div>
      </div>
      <div class="step" id="stepTranscribe">
        <div class="step-icon">ü§ñ</div>
        <div class="step-text">
          <div class="step-title">AI„ÅßÊñáÂ≠óËµ∑„Åì„Åó‰∏≠...</div>
          <div class="step-detail">„É≠„Éº„Ç´„É´Whisper„ÅßÈü≥Â£∞Ë™çË≠ò„Åó„Åæ„ÅôÔºàÂàùÂõû„ÅØ„É¢„Éá„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´ÊôÇÈñì„Åå„Åã„Åã„Çä„Åæ„ÅôÔºâ</div>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div class="result-section" id="resultSection">

      <!-- Tab Navigation -->
      <div class="tab-nav" id="tabNav">
        <button class="tab-btn active" onclick="switchTab('subtitle')" data-tab="subtitle">
          <span class="tab-icon">üìù</span> Â≠óÂπï
        </button>
        <button class="tab-btn" onclick="switchTab('edit')" data-tab="edit">
          <span class="tab-icon">üé¨</span> Á∑®ÈõÜ
        </button>
        <button class="tab-btn" onclick="switchTab('effects')" data-tab="effects">
          <span class="tab-icon">‚ú®</span> „Ç®„Éï„Çß„ÇØ„Éà
        </button>
        <button class="tab-btn" onclick="switchTab('export')" data-tab="export">
          <span class="tab-icon">üì§</span> Âá∫Âäõ
        </button>
      </div>

      <!-- ‚îÄ‚îÄ Tab: Â≠óÂπï ‚îÄ‚îÄ -->
      <div class="tab-panel active" id="tabSubtitle">
        <div class="result-card">
          <div class="result-title">üìù Â≠óÂπïÁ∑®ÈõÜ</div>
          <div class="subtitle-list" id="subtitleList"></div>
          <button class="btn-add" onclick="addSubtitle()">Ôºã Â≠óÂπï„ÇíËøΩÂä†</button>
        </div>

        <!-- Style Settings -->
        <div class="style-card">
          <div class="style-title">üé® „Çπ„Çø„Ç§„É´Ë®≠ÂÆö</div>
          <div class="style-grid">
            <div class="style-field" style="grid-column: 1 / -1">
              <label>„Éï„Ç©„É≥„Éà</label>
              <select id="styleFont" onchange="updateStyle()">
                <optgroup label="‚Äî „Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì ‚Äî">
                  <option value="Noto Sans CJK JP">Noto Sans „Ç¥„Ç∑„ÉÉ„ÇØ</option>
                </optgroup>
                <optgroup label="‚Äî ÊòéÊúù‰Ωì ‚Äî">
                  <option value="Noto Serif CJK JP">Noto Serif ÊòéÊúù</option>
                </optgroup>
                <optgroup label="‚Äî ÊâãÊõ∏„Åç„Éª„Éù„ÉÉ„Éó ‚Äî">
                  <option value="Yusei Magic">„É¶„Ç¶„Çª„Ç§„Éû„Ç∏„ÉÉ„ÇØ</option>
                  <option value="LightNovelPopV2">„É©„Éé„ÉôPOP</option>
                </optgroup>
              </select>
            </div>
            <div class="style-field">
              <label>„Çµ„Ç§„Ç∫ (px)</label>
              <input type="number" id="styleFontSize" value="42" min="16" max="400" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>Â§™Â≠ó</label>
              <div class="toggle-row">
                <button class="toggle active" id="styleBold"
                  onclick="this.classList.toggle('active'); updateStyle()"></button>
                <span style="font-size:13px; color:#888" id="boldLabel">ON</span>
              </div>
            </div>
            <div class="style-field">
              <label>„Ç´„É©„Éº„Éó„É™„Çª„ÉÉ„Éà</label>
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-top:4px">
                <button onclick="applyColorPreset('#ffffff','#0055ff',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#0055ff; color:#fff; -webkit-text-stroke:1px #0055ff">ÁôΩ-Èùí</button>
                <button onclick="applyColorPreset('#ffffff','#dd0000',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#dd0000; color:#fff; -webkit-text-stroke:1px #dd0000">ÁôΩ-Ëµ§</button>
                <button onclick="applyColorPreset('#ffffff','#000000',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#333; color:#fff; -webkit-text-stroke:1px #000">ÁôΩ-Èªí</button>
                <button onclick="applyColorPreset('#ffdd00','#000000',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#333; color:#ffdd00; -webkit-text-stroke:1px #000">ÈªÑ-Èªí</button>
                <button onclick="applyColorPreset('#66ddff','#001a4d',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#001a4d; color:#66ddff; -webkit-text-stroke:1px #001a4d">Ê∞¥Ëâ≤-Á¥∫</button>
                <button onclick="applyColorPreset('#000000','#ffffff',3)"
                  style="padding:6px 4px; border-radius:6px; border:1px solid #444; cursor:pointer; font-size:11px; font-weight:bold; background:#eee; color:#000; -webkit-text-stroke:1px #fff">Èªí-ÁôΩ</button>
              </div>
            </div>
            <div class="style-field">
              <label>Á∏ÅÂèñ„ÇäÂπÖ (px)</label>
              <input type="number" id="styleOutlineWidth" value="0" min="0" max="10" step="1" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>Á∏ÅÂèñ„ÇäËâ≤</label>
              <div class="color-row">
                <input type="color" id="styleOutlineColor" value="#000000" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleOutlineColorHex" value="#000000"
                  onchange="document.getElementById('styleOutlineColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>ÊñáÂ≠ó„ÅÆËâ≤</label>
              <div class="color-row">
                <input type="color" id="styleFontColor" value="#ffffff" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleFontColorHex" value="#ffffff"
                  onchange="document.getElementById('styleFontColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>ËÉåÊôØ„ÅÆËâ≤</label>
              <div class="color-row">
                <input type="color" id="styleBgColor" value="#000000" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleBgColorHex" value="#000000"
                  onchange="document.getElementById('styleBgColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>ËÉåÊôØ„ÅÆÈÄèÊòéÂ∫¶ (%)</label>
              <input type="number" id="styleBgOpacity" value="75" min="0" max="100" step="5" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ</label>
              <div class="pos-buttons">
                <button class="pos-btn" onclick="setPosition('top')">‰∏ä</button>
                <button class="pos-btn" onclick="setPosition('center')">‰∏≠Â§Æ</button>
                <button class="pos-btn active" onclick="setPosition('bottom')">‰∏ã</button>
                <button class="pos-btn" onclick="setPosition('custom')">XYÊåáÂÆö</button>
              </div>
            </div>
            <div class="style-field" id="customPosField" style="display:none">
              <label>„Ç´„Çπ„Çø„É†‰ΩçÁΩÆ (X%, Y%)</label>
              <div class="color-row">
                <span style="color:#888; font-size:12px">X</span>
                <input type="number" id="stylePosX" value="50" min="0" max="100" style="width:60px"
                  onchange="updateStyle()">
                <span style="color:#888; font-size:12px">Y</span>
                <input type="number" id="stylePosY" value="90" min="0" max="100" style="width:60px"
                  onchange="updateStyle()">
              </div>
            </div>
          </div>
          <div class="style-preview" id="stylePreview">
            <div class="style-preview-text" id="stylePreviewText">„Çµ„É≥„Éó„É´Â≠óÂπï„ÉÜ„Ç≠„Çπ„Éà</div>
          </div>
        </div>

        <!-- Animation -->
        <div class="style-card">
          <div class="style-title">‚ú® „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥</div>
          <div class="style-grid">
            <div class="style-field" style="grid-column: 1 / -1">
              <label>„Éá„Éï„Ç©„É´„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥</label>
              <select id="styleAnimation" onchange="updateStyle()">
                <option value="fadeIn">„Éï„Çß„Éº„Éâ„Ç§„É≥</option>
                <option value="slideUp">„Çπ„É©„Ç§„Éâ„Ç¢„ÉÉ„Éó ‚Üë</option>
                <option value="slideDown">„Çπ„É©„Ç§„Éâ„ÉÄ„Ç¶„É≥ ‚Üì</option>
                <option value="pop">„Éù„ÉÉ„Éó</option>
                <option value="bounce">„Éê„Ç¶„É≥„Çπ</option>
                <option value="typewriter">„Çø„Ç§„Éó„É©„Ç§„Çø„Éº</option>
                <option value="none">„Å™„Åó</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tab: Á∑®ÈõÜ ‚îÄ‚îÄ -->
      <div class="tab-panel" id="tabEdit">
        <!-- Audio Tracks -->
        <div class="audio-card">
          <div class="audio-title">üîä „Çµ„Ç¶„É≥„Éâ</div>
          <div id="audioTrackList"></div>
          <button class="audio-upload-btn" onclick="document.getElementById('audioFileInput').click()">Ôºã
            Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÇíËøΩÂä†</button>
          <input type="file" id="audioFileInput" accept="audio/*" style="display:none" onchange="uploadAudioFile(this)">
        </div>

        <!-- Video Editing -->
        <div class="edit-card">
          <div class="edit-title">üé¨ ÂãïÁîªÁ∑®ÈõÜ</div>

          <!-- Trim -->
          <div class="edit-section">
            <div class="edit-section-title">‚úÇÔ∏è „Éà„É™„Éü„É≥„Ç∞</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>ÈñãÂßã</label>
                <input type="number" id="trimStart" value="0" min="0" step="0.1" onchange="updateEditSettings()">
                <label>Áßí</label>
              </div>
              <span style="color:#555">‚Üí</span>
              <div class="edit-field">
                <label>ÁµÇ‰∫Ü</label>
                <input type="number" id="trimEnd" value="" min="0" step="0.1" placeholder="ÊúÄÂæå"
                  onchange="updateEditSettings()">
                <label>Áßí</label>
              </div>
            </div>
            <div class="edit-hint">‚Äª ÁµÇ‰∫Ü„ÅåÁ©∫Ê¨Ñ„ÅÆÂ†¥Âêà„ÅØÂãïÁîª„ÅÆÊúÄÂæå„Åæ„Åß</div>
          </div>

          <!-- Transition -->
          <div class="edit-section">
            <div class="edit-section-title">‚ú® „Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>„Éï„Çß„Éº„Éâ„Ç§„É≥</label>
                <input type="number" id="fadeIn" value="0" min="0" max="5" step="0.1" onchange="updateEditSettings()">
                <label>Áßí</label>
              </div>
              <div class="edit-field">
                <label>„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà</label>
                <input type="number" id="fadeOut" value="0" min="0" max="5" step="0.1" onchange="updateEditSettings()">
                <label>Áßí</label>
              </div>
            </div>
          </div>

          <!-- Speed -->
          <div class="edit-section">
            <div class="edit-section-title">‚è© ÂÜçÁîüÈÄüÂ∫¶</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>ÂÄçÈÄü</label>
                <input type="number" id="playbackSpeed" value="1" min="0.1" max="4" step="0.1"
                  onchange="updateEditSettings(); updateSpeedPresets()">
                <label>x</label>
              </div>
            </div>
            <div class="speed-presets">
              <button class="speed-preset-btn" onclick="setSpeed(0.25)">0.25x</button>
              <button class="speed-preset-btn" onclick="setSpeed(0.5)">0.5x</button>
              <button class="speed-preset-btn active" onclick="setSpeed(1)">1x</button>
              <button class="speed-preset-btn" onclick="setSpeed(1.5)">1.5x</button>
              <button class="speed-preset-btn" onclick="setSpeed(2)">2x</button>
              <button class="speed-preset-btn" onclick="setSpeed(4)">4x</button>
            </div>
            <div class="edit-hint">‚Äª 0.5x = „Çπ„É≠„Éº„É¢„Éº„Ç∑„Éß„É≥„ÄÅ 2x = Êó©ÈÄÅ„Çä</div>
          </div>

          <!-- Merge -->
          <div class="edit-section">
            <div class="edit-section-title">üîó ÂãïÁîª„ÅÆÁµêÂêà</div>
            <div id="mergeVideoList"></div>
            <button class="merge-upload-btn" onclick="document.getElementById('mergeVideoInput').click()">Ôºã
              ÂãïÁîª„ÇíËøΩÂä†„Åó„Å¶ÁµêÂêà</button>
            <input type="file" id="mergeVideoInput" accept="video/*" style="display:none"
              onchange="uploadMergeVideo(this)">
            <div class="edit-hint">‚Äª „É°„Ç§„É≥ÂãïÁîª„ÅÆÂæå„Çç„Å´ÁµêÂêà„Åï„Çå„Åæ„Åô</div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tab: „Ç®„Éï„Çß„ÇØ„Éà ‚îÄ‚îÄ -->
      <div class="tab-panel" id="tabEffects">
        <!-- Image Overlays -->
        <div class="visual-card">
          <div class="visual-title overlay">üñºÔ∏è ÁîªÂÉè„Ç™„Éº„Éê„Éº„É¨„Ç§</div>
          <div id="overlayList"></div>
          <button class="overlay-upload-btn" onclick="document.getElementById('overlayImageInput').click()">Ôºã
            ÁîªÂÉè„ÇíËøΩÂä†</button>
          <input type="file" id="overlayImageInput" accept="image/*" style="display:none"
            onchange="uploadOverlayImage(this)">
          <div class="edit-hint">‚Äª „É≠„Ç¥„ÄÅ„Çπ„Çø„É≥„Éó„ÄÅ„Éï„É¨„Éº„É†„Å™„Å©„ÇíÂ•Ω„Åç„Å™‰ΩçÁΩÆ„Éª„Çø„Ç§„Éü„É≥„Ç∞„ÅßË°®Á§∫</div>
        </div>

        <!-- Filters -->
        <div class="visual-card">
          <div class="visual-title filter">üé® „Éï„Ç£„É´„Çø„Éº / Ëâ≤Ë™øË£úÊ≠£</div>
          <div class="filter-grid">
            <div class="filter-item">
              <label>Êòé„Çã„Åï <span id="filterBrightnessVal">100%</span></label>
              <input type="range" id="filterBrightness" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>„Ç≥„É≥„Éà„É©„Çπ„Éà <span id="filterContrastVal">100%</span></label>
              <input type="range" id="filterContrast" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>ÂΩ©Â∫¶ <span id="filterSaturateVal">100%</span></label>
              <input type="range" id="filterSaturate" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>„Çª„Éî„Ç¢ <span id="filterSepiaVal">0%</span></label>
              <input type="range" id="filterSepia" min="0" max="100" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>„É¢„Éé„ÇØ„É≠ <span id="filterGrayscaleVal">0%</span></label>
              <input type="range" id="filterGrayscale" min="0" max="100" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>Ëâ≤Áõ∏ÂõûËª¢ <span id="filterHueVal">0¬∞</span></label>
              <input type="range" id="filterHue" min="0" max="360" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>„Åº„Åã„Åó <span id="filterBlurVal">0px</span></label>
              <input type="range" id="filterBlur" min="0" max="20" value="0" step="0.5" oninput="updateFilters()">
            </div>
            <div class="filter-item" style="display:flex; align-items:flex-end; justify-content:flex-end">
              <button class="btn-reset" onclick="resetFilters()">‚Ü∫ „É™„Çª„ÉÉ„Éà</button>
            </div>
          </div>
        </div>

        <!-- Ken Burns -->
        <div class="visual-card">
          <div class="visual-title kenburns">üì∑ „Ç∫„Éº„É† / „Éë„É≥ÔºàKen BurnsÔºâ</div>
          <div style="margin-bottom:12px">
            <div class="toggle-row">
              <button class="toggle" id="kbToggle" onclick="this.classList.toggle('active'); updateKenBurns()"></button>
              <span style="font-size:13px; color:#888" id="kbLabel">OFF</span>
            </div>
          </div>
          <div id="kbControls" style="display:none">
            <div class="edit-hint" style="margin-bottom:8px">‚Äª ÈñãÂßã‚ÜíÁµÇ‰∫Ü„Å´„Åã„Åë„Å¶ÂÄ§„ÅåÂ§âÂåñ„Åó„Åæ„Åô</div>
            <div class="kb-grid">
              <div>
                <div style="font-size:12px; color:#888; margin-bottom:6px">ÈñãÂßã</div>
                <div class="kb-field">
                  <label>„Ç∫„Éº„É†</label>
                  <input type="number" id="kbStartScale" value="1.0" min="0.5" max="3" step="0.05"
                    onchange="updateKenBurns()">
                </div>
                <div class="kb-field" style="margin-top:6px">
                  <label>X</label>
                  <input type="number" id="kbStartX" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                  <label>Y</label>
                  <input type="number" id="kbStartY" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                </div>
              </div>
              <div>
                <div style="font-size:12px; color:#888; margin-bottom:6px">ÁµÇ‰∫Ü</div>
                <div class="kb-field">
                  <label>„Ç∫„Éº„É†</label>
                  <input type="number" id="kbEndScale" value="1.2" min="0.5" max="3" step="0.05"
                    onchange="updateKenBurns()">
                </div>
                <div class="kb-field" style="margin-top:6px">
                  <label>X</label>
                  <input type="number" id="kbEndX" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                  <label>Y</label>
                  <input type="number" id="kbEndY" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                </div>
              </div>
            </div>
            <div class="speed-presets" style="margin-top:10px">
              <button class="speed-preset-btn" onclick="setKBPreset(1.0,1.2,0,0,0,0)">„Ç∫„Éº„É†„Ç§„É≥</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.2,1.0,0,0,0,0)">„Ç∫„Éº„É†„Ç¢„Ç¶„Éà</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.1,1.1,-10,10,0,0)">Â∑¶‚ÜíÂè≥„Éë„É≥</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.15,1.15,0,0,5,-5)">‰∏ã‚Üí‰∏ä„Éë„É≥</button>
            </div>
          </div>
        </div>

        <!-- Free Telop -->
        <div class="telop-card">
          <div class="telop-title">üìù „Éï„É™„Éº„ÉÜ„É≠„ÉÉ„Éó</div>
          <div id="telopList"></div>
          <button class="telop-add-btn" onclick="addTelop()">Ôºã „ÉÜ„É≠„ÉÉ„Éó„ÇíËøΩÂä†</button>
          <div class="edit-hint">‚Äª Â≠óÂπï„Å®„ÅØÂà•„Å´Ëá™Áî±„Å™„ÉÜ„Ç≠„Çπ„Éà„ÇíÂ•Ω„Åç„Å™‰ΩçÁΩÆ„Éª„Çø„Ç§„Éü„É≥„Ç∞„ÅßË°®Á§∫</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Tab: Âá∫Âäõ ‚îÄ‚îÄ -->
      <div class="tab-panel" id="tabExport">
        <!-- Export Section -->
        <div class="export-card">
          <div class="export-title">üì§ „Ç®„ÇØ„Çπ„Éù„Éº„Éà</div>

          <!-- MP4 Render -->
          <div class="export-section">
            <div class="export-section-title">üé¨ MP4„É¨„É≥„ÉÄ„É™„É≥„Ç∞</div>
            <div class="export-row">
              <button class="export-btn" id="previewBtn" onclick="startPreview()"
                style="background:linear-gradient(135deg,#222222,#222222);">üëÅÔ∏è „Éó„É¨„Éì„É•„Éº (5Áßí)</button>
              <button class="export-btn render" id="renderBtn" onclick="startRender()">üì¶ ÂãïÁîª„ÇíÊõ∏„ÅçÂá∫„Åó</button>
            </div>
            <div class="edit-hint">‚Äª „Éó„É¨„Éì„É•„Éº: ÁèæÂú®‰ΩçÁΩÆ„Åã„Çâ5ÁßíÈñì„ÇíÈ´òÈÄü„É¨„É≥„ÉÄ„É™„É≥„Ç∞ Ôºè Êõ∏„ÅçÂá∫„Åó: ÂÖ®‰Ωì„ÇíÈ´òÂìÅË≥™„É¨„É≥„ÉÄ„É™„É≥„Ç∞</div>
            <div class="render-status" id="renderStatus"></div>
            <div id="renderResult"></div>
          </div>

          <!-- SRT/VTT -->
          <div class="export-section">
            <div class="export-section-title">üìù Â≠óÂπï„Éï„Ç°„Ç§„É´„Ç®„ÇØ„Çπ„Éù„Éº„Éà</div>
            <div class="export-row">
              <div class="export-field">
                <label>ÂΩ¢Âºè</label>
                <select id="exportSubFormat">
                  <option value="srt">SRTÔºàYouTubeÂØæÂøúÔºâ</option>
                  <option value="vtt">WebVTT</option>
                </select>
              </div>
              <button class="export-btn sub" onclick="exportSubtitles()">‚¨á „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </div>
            <div class="edit-hint">‚Äª YouTube„ÇÑÂãïÁîª„Éó„É¨„Ç§„É§„ÉºÁî®„ÅÆÂ≠óÂπï„Éï„Ç°„Ç§„É´</div>
          </div>

          <!-- Thumbnail -->
          <div class="export-section">
            <div class="export-section-title">üñºÔ∏è „Çµ„É†„Éç„Ç§„É´ÁîüÊàê</div>
            <div class="export-row">
              <div class="export-field">
                <label>ÊôÇÂàª</label>
                <input type="number" id="thumbTime" value="0" min="0" step="0.1">
                <label>Áßí</label>
              </div>
              <button class="export-btn thumb" onclick="generateThumbnail()">üì∏ ÁîüÊàê</button>
            </div>
            <div class="edit-hint">‚Äª ÊåáÂÆö„Åó„ÅüÊôÇÂàª„ÅÆ„Éï„É¨„Éº„É†„ÇíJPEG„Åß‰øùÂ≠ò</div>
            <div id="thumbResult"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-save" onclick="saveAll()">üíæ ‰øùÂ≠ò</button>
          <button class="btn btn-primary" onclick="saveAndOpenStudio()">Remotion Studio„ÅßÁ¢∫Ë™ç ‚Üí</button>
          <button class="btn btn-secondary" onclick="location.reload()">Âà•„ÅÆÂãïÁîª„ÇíÂá¶ÁêÜ</button>
        </div>

        <!-- Utility Bar -->
        <div class="utility-bar" id="utilityBar">
          <span class="utility-title">üõ†</span>
          <button class="util-btn undo" id="undoBtn" onclick="undo()" disabled title="Ctrl+Z">‚Ü© Êàª„Åô</button>
          <button class="util-btn redo" id="redoBtn" onclick="redo()" disabled title="Ctrl+Shift+Z">‚Ü™ „ÇÑ„ÇäÁõ¥„Åó</button>
          <span class="undo-count" id="undoCount"></span>
          <div class="util-sep"></div>
          <button class="util-btn project-save" onclick="downloadProject()" title="„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠ò">üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰øùÂ≠ò</button>
          <button class="util-btn project-load" onclick="document.getElementById('projectFileInput').click()"
            title="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË™≠Ëæº">üìÇ Ë™≠Ëæº</button>
          <input type="file" id="projectFileInput" accept=".json" style="display:none" onchange="loadProject(this)">
          <div class="util-sep"></div>
          <button class="util-btn shortcut-help"
            onclick="document.getElementById('shortcutPanel').classList.toggle('open')" title="„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà‰∏ÄË¶ß">‚å®
            „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà</button>
        </div>
        <div class="shortcut-panel" id="shortcutPanel">
          <table>
            <tr>
              <td>Ctrl + S</td>
              <td>‰øùÂ≠òÔºàÂÖ®Ë®≠ÂÆö„Çí„Çµ„Éº„Éê„Éº„Å´‰øùÂ≠òÔºâ</td>
            </tr>
            <tr>
              <td>Ctrl + Z</td>
              <td>ÂÖÉ„Å´Êàª„Åô</td>
            </tr>
            <tr>
              <td>Ctrl + Shift + Z</td>
              <td>„ÇÑ„ÇäÁõ¥„Åó</td>
            </tr>
            <tr>
              <td>Ctrl + E</td>
              <td>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíJSON„Åß‰øùÂ≠ò</td>
            </tr>
            <tr>
              <td>Ctrl + O</td>
              <td>„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„Åø</td>
            </tr>
            <tr>
              <td>Ctrl + Enter</td>
              <td>Remotion Studio„ÇíÈñã„Åè</td>
            </tr>
          </table>
        </div>
      </div><!-- /tabExport -->
    </div><!-- /resultSection -->
    <div class="save-toast" id="saveToast">‚úÖ ‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>

    <div class="error-msg" id="errorMsg"></div>
  </div>

  <script>
    // Tab Navigation
    function switchTab(tabName) {
      const panelMap = {
        subtitle: 'tabSubtitle',
        edit: 'tabEdit',
        effects: 'tabEffects',
        export: 'tabExport'
      };
      // Deactivate all
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      // Activate clicked
      document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(panelMap[tabName]).classList.add('active');
    }

    const SERVER = window.location.origin;
    let currentFilename = "";
    let currentSubtitles = [];
    let currentStyle = {
      fontFamily: "Noto Sans CJK JP",
      fontSize: 42,
      fontColor: "#ffffff",
      bgColor: "#000000",
      bgOpacity: 0.75,
      position: "bottom",
      posX: 50,
      posY: 90,
      bold: true,
      animation: "fadeIn",
      outlineWidth: 0,
      outlineColor: "#000000"
    };
    let audioTracks = [];
    let editSettings = {
      trim: { startTime: 0, endTime: null },
      transition: { fadeIn: 0, fadeOut: 0 },
      speedSections: [{ start: 0, end: 9999, speed: 1 }],
      additionalVideos: [],
      imageOverlays: [],
      filters: { brightness: 100, contrast: 100, saturate: 100, sepia: 0, grayscale: 0, hueRotate: 0, blur: 0 },
      kenBurns: { enabled: false, startScale: 1.0, endScale: 1.2, startX: 0, endX: 0, startY: 0, endY: 0 },
      textOverlays: []
    };

    // ‚îÄ‚îÄ „Éó„É¨„Éì„É•„ÉºÂ≠óÂπï„Ç™„Éº„Éê„Éº„É¨„Ç§ ‚îÄ‚îÄ
    function updateSubtitleOverlay() {
      const overlay = document.getElementById('subtitleOverlay');
      const video = document.getElementById('previewVideo');
      if (!overlay || !video) return;

      const t = video.currentTime;
      let html = '';

      // Â≠óÂπïË°®Á§∫
      const activeSubs = currentSubtitles.filter(s => t >= s.start && t <= s.end);
      activeSubs.forEach(sub => {
        const font = sub.fontFamily || currentStyle.fontFamily;
        const size = sub.fontSize || currentStyle.fontSize;
        const color = sub.fontColor || currentStyle.fontColor;
        const bg = sub.bgColor || currentStyle.bgColor;
        const opacity = currentStyle.bgOpacity;
        const bold = (sub.bold !== undefined ? sub.bold : currentStyle.bold) ? 'bold' : 'normal';
        const pos = currentStyle.position || 'bottom';

        // „Éì„Éá„Ç™„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„Çí„Çπ„Ç±„Éº„É´
        const videoEl = video.getBoundingClientRect();
        const scale = videoEl.width / 1920; // 1920Âü∫Ê∫ñ„Åß„Çπ„Ç±„Éº„É´
        const scaledSize = Math.max(12, Math.round(size * scale));

        const posClass = (sub.posX !== undefined && sub.posY !== undefined) ? '' : pos;
        let posStyle = '';
        if (sub.posX !== undefined && sub.posY !== undefined) {
          posStyle = `left:${sub.posX}%;top:${sub.posY}%;transform:translate(-50%,-50%);`;
        }

        html += `<div class="sub-line ${posClass}" style="
          font-family:'${font}',sans-serif;
          font-size:${scaledSize}px;
          color:${color};
          background:rgba(${parseInt(bg.slice(1, 3), 16)},${parseInt(bg.slice(3, 5), 16)},${parseInt(bg.slice(5, 7), 16)},${opacity});
          font-weight:${bold};
          ${posStyle}
        ">${sub.text}</div>`;
      });

      // „ÉÜ„É≠„ÉÉ„ÉóË°®Á§∫
      const telops = editSettings.textOverlays || [];
      telops.forEach(item => {
        if (t >= item.startTime && t <= item.endTime) {
          const videoEl = video.getBoundingClientRect();
          const scale = videoEl.width / 1920;
          const scaledSize = Math.max(10, Math.round(item.fontSize * scale));
          const bgA = item.bgOpacity || 0;
          const bg = item.bgColor || '#000000';

          html += `<div class="telop-line" style="
            left:${item.posX}%;top:${item.posY}%;transform:translate(-50%,-50%);
            font-family:'${item.fontFamily}',sans-serif;
            font-size:${scaledSize}px;
            color:${item.fontColor};
            background:rgba(${parseInt(bg.slice(1, 3), 16)},${parseInt(bg.slice(3, 5), 16)},${parseInt(bg.slice(5, 7), 16)},${bgA});
            font-weight:${item.bold ? 'bold' : 'normal'};
          ">${item.text}</div>`;
        }
      });

      overlay.innerHTML = html;
    }

    // „Éì„Éá„Ç™„Å´timeupdate„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
    function setupVideoOverlay() {
      const video = document.getElementById('previewVideo');
      if (video) {
        video.addEventListener('timeupdate', updateSubtitleOverlay);
      }
    }
    // DOM„É≠„Éº„ÉâÂæå„Å´Ë®≠ÂÆö
    document.addEventListener('DOMContentLoaded', setupVideoOverlay);

    // Undo/Redo
    let undoStack = [];
    let redoStack = [];
    const MAX_UNDO = 50;

    function takeSnapshot() {
      const snap = JSON.stringify({ currentSubtitles, currentStyle, audioTracks, editSettings });
      if (undoStack.length > 0 && undoStack[undoStack.length - 1] === snap) return;
      undoStack.push(snap);
      if (undoStack.length > MAX_UNDO) undoStack.shift();
      redoStack = [];
      updateUndoButtons();
    }

    function undo() {
      if (undoStack.length < 2) return;
      redoStack.push(undoStack.pop());
      const snap = JSON.parse(undoStack[undoStack.length - 1]);
      currentSubtitles = snap.currentSubtitles;
      currentStyle = snap.currentStyle;
      audioTracks = snap.audioTracks;
      editSettings = snap.editSettings;
      refreshUI();
      updateUndoButtons();
    }

    function redo() {
      if (redoStack.length === 0) return;
      const snap = JSON.parse(redoStack.pop());
      undoStack.push(JSON.stringify(snap));
      currentSubtitles = snap.currentSubtitles;
      currentStyle = snap.currentStyle;
      audioTracks = snap.audioTracks;
      editSettings = snap.editSettings;
      refreshUI();
      updateUndoButtons();
    }

    function updateUndoButtons() {
      document.getElementById('undoBtn').disabled = undoStack.length < 2;
      document.getElementById('redoBtn').disabled = redoStack.length === 0;
      const count = document.getElementById('undoCount');
      count.textContent = `${undoStack.length - 1}/${MAX_UNDO}`;
    }

    function refreshUI() {
      displayResults();
      displayAudioTracks();
      displayOverlays();
      displayMergeVideos();
      displayTelops();
    }

    // Drag & Drop
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("dragover");
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith("video/")) {
        processFile(file);
      }
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });

    function setStep(id, state) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = `step ${state}`;
      if (state === "active") {
        el.style.display = "";
        const icon = el.querySelector(".step-icon");
        icon.innerHTML = '<div class="spinner"></div>';
      } else if (state === "done") {
        const icon = el.querySelector(".step-icon");
        icon.textContent = "‚úÖ";
      } else if (state === "error") {
        const icon = el.querySelector(".step-icon");
        icon.textContent = "‚ùå";
      }
    }

    // ‚îÄ‚îÄ FFmpeg.wasm helpers ‚îÄ‚îÄ
    let ffmpegInstance = null;
    let ffmpegLoaded = false;

    async function loadFFmpeg() {
      if (ffmpegLoaded && ffmpegInstance) return ffmpegInstance;
      const { FFmpeg } = FFmpegWASM;
      const { toBlobURL } = FFmpegUtil;
      ffmpegInstance = new FFmpeg();
      const baseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd';
      await ffmpegInstance.load({
        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
      });
      ffmpegLoaded = true;
      return ffmpegInstance;
    }

    async function compressVideo(file) {
      const COMPRESS_THRESHOLD = 50 * 1024 * 1024; // 50MB
      if (file.size <= COMPRESS_THRESHOLD) {
        return file;
      }

      const stepCompress = document.getElementById('stepCompress');
      stepCompress.style.display = '';
      setStep('stepCompress', 'active');
      document.getElementById('compressDetail').textContent =
        `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB) ‚Üí ÂúßÁ∏Æ‰∏≠...`;

      const progressFill = document.getElementById('compressProgressFill');
      const statsEl = document.getElementById('compressStats');

      try {
        const ffmpeg = await loadFFmpeg();

        // Track progress via progress event
        ffmpeg.on('progress', ({ progress }) => {
          const pct = Math.min(99, Math.max(0, Math.round(progress * 100)));
          progressFill.style.width = pct + '%';
          statsEl.textContent = `${pct}% ÂÆå‰∫Ü`;
        });

        const inputName = 'input' + (file.name.endsWith('.mov') ? '.mov' : '.mp4');
        const outputName = 'compressed.mp4';

        const { fetchFile } = FFmpegUtil;
        await ffmpeg.writeFile(inputName, await fetchFile(file));

        await ffmpeg.exec([
          '-i', inputName,
          '-vf', 'scale=-2:1080',
          '-c:v', 'libx264',
          '-preset', 'fast',
          '-crf', '28',
          '-c:a', 'aac',
          '-b:a', '128k',
          '-movflags', '+faststart',
          '-y', outputName
        ]);

        const data = await ffmpeg.readFile(outputName);
        const compressedBlob = new Blob([data.buffer], { type: 'video/mp4' });

        // Clean up
        await ffmpeg.deleteFile(inputName);
        await ffmpeg.deleteFile(outputName);

        // Use compressed only if smaller
        if (compressedBlob.size >= file.size) {
          document.getElementById('compressDetail').textContent =
            `ÂúßÁ∏ÆÂæå„ÅÆ„Çµ„Ç§„Ç∫„ÅåÂÖÉ„Çà„ÇäÂ§ß„Åç„ÅÑ„Åü„ÇÅ„ÄÅÂÖÉ„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®„Åó„Åæ„Åô`;
          progressFill.style.width = '100%';
          statsEl.textContent = '';
          setStep('stepCompress', 'done');
          return file;
        }

        const ratio = ((1 - compressedBlob.size / file.size) * 100).toFixed(0);
        document.getElementById('compressDetail').textContent =
          `${(file.size / 1024 / 1024).toFixed(1)}MB ‚Üí ${(compressedBlob.size / 1024 / 1024).toFixed(1)}MB (${ratio}%ÂâäÊ∏õ)`;
        progressFill.style.width = '100%';
        statsEl.textContent = 'ÂúßÁ∏ÆÂÆå‰∫Ü';
        setStep('stepCompress', 'done');

        const compressedFile = new File([compressedBlob], file.name.replace(/\.[^.]+$/, '.mp4'), { type: 'video/mp4' });
        return compressedFile;

      } catch (err) {
        console.error('Compression failed:', err);
        document.getElementById('compressDetail').textContent =
          `ÂúßÁ∏Æ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÖÉ„Éï„Ç°„Ç§„É´„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åô`;
        statsEl.textContent = '';
        setStep('stepCompress', 'error');
        return file; // fallback to original
      }
    }

    function uploadWithProgress(url, formData) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const progressFill = document.getElementById('uploadProgressFill');
        const statsEl = document.getElementById('uploadStats');

        let startTime = Date.now();

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = pct + '%';

            const elapsed = (Date.now() - startTime) / 1000;
            const speed = e.loaded / elapsed;
            const remaining = elapsed > 0 ? (e.total - e.loaded) / speed : 0;

            statsEl.textContent = `${pct}% | ${formatSpeed(speed)} | ÊÆã„ÇäÁ¥Ñ${formatTime(remaining)}`;
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            progressFill.style.width = '100%';
            statsEl.textContent = '„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü';
            try {
              resolve(JSON.parse(xhr.responseText));
            } catch (e) {
              reject(new Error('„É¨„Çπ„Éù„É≥„Çπ„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
            }
          } else {
            reject(new Error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'));
          }
        });

        xhr.addEventListener('error', () => {
          reject(new Error('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü'));
        });

        xhr.open('POST', url);
        xhr.send(formData);
      });
    }

    function formatSpeed(bytesPerSec) {
      if (bytesPerSec >= 1024 * 1024) return (bytesPerSec / 1024 / 1024).toFixed(1) + ' MB/s';
      if (bytesPerSec >= 1024) return (bytesPerSec / 1024).toFixed(0) + ' KB/s';
      return bytesPerSec.toFixed(0) + ' B/s';
    }

    function formatTime(seconds) {
      if (seconds < 1) return '1ÁßíÊú™Ê∫Ä';
      if (seconds < 60) return Math.ceil(seconds) + 'Áßí';
      return Math.ceil(seconds / 60) + 'ÂàÜ';
    }

    function applyColorPreset(fontColor, outlineColor, outlineWidth) {
      document.getElementById('styleFontColor').value = fontColor;
      document.getElementById('styleFontColorHex').value = fontColor;
      document.getElementById('styleOutlineColor').value = outlineColor;
      document.getElementById('styleOutlineColorHex').value = outlineColor;
      document.getElementById('styleOutlineWidth').value = outlineWidth;
      document.getElementById('styleBgOpacity').value = '0';
      updateStyle();
    }

    function updateStyle() {
      currentStyle.fontFamily = document.getElementById('styleFont').value;
      currentStyle.fontSize = parseInt(document.getElementById('styleFontSize').value);
      currentStyle.fontColor = document.getElementById('styleFontColor').value;
      currentStyle.bgColor = document.getElementById('styleBgColor').value;
      currentStyle.bgOpacity = parseInt(document.getElementById('styleBgOpacity').value) / 100;
      currentStyle.bold = document.getElementById('styleBold').classList.contains('active');
      currentStyle.posX = parseInt(document.getElementById('stylePosX').value) || 50;
      currentStyle.posY = parseInt(document.getElementById('stylePosY').value) || 90;
      document.getElementById('styleFontColorHex').value = currentStyle.fontColor;
      document.getElementById('styleBgColorHex').value = currentStyle.bgColor;
      document.getElementById('boldLabel').textContent = currentStyle.bold ? 'ON' : 'OFF';
      currentStyle.animation = document.getElementById('styleAnimation').value;
      currentStyle.outlineWidth = parseInt(document.getElementById('styleOutlineWidth').value) || 0;
      currentStyle.outlineColor = document.getElementById('styleOutlineColor').value;
      document.getElementById('styleOutlineColorHex').value = currentStyle.outlineColor;
      document.getElementById('customPosField').style.display = currentStyle.position === 'custom' ? '' : 'none';
      updatePreview();
    }

    function setPosition(pos) {
      currentStyle.position = pos;
      document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('customPosField').style.display = pos === 'custom' ? '' : 'none';
      updatePreview();
    }

    function updatePreview() {
      const preview = document.getElementById('stylePreview');
      const text = document.getElementById('stylePreviewText');
      const r = parseInt(currentStyle.bgColor.slice(1, 3), 16);
      const g = parseInt(currentStyle.bgColor.slice(3, 5), 16);
      const b = parseInt(currentStyle.bgColor.slice(5, 7), 16);
      text.style.backgroundColor = `rgba(${r},${g},${b},${currentStyle.bgOpacity})`;
      text.style.color = currentStyle.fontColor;
      text.style.fontSize = Math.min(currentStyle.fontSize, 32) + 'px';
      text.style.fontWeight = currentStyle.bold ? 'bold' : 'normal';
      text.style.fontFamily = `'${currentStyle.fontFamily}', sans-serif`;
      if (currentStyle.outlineWidth > 0) {
        text.style.webkitTextStroke = `${currentStyle.outlineWidth}px ${currentStyle.outlineColor}`;
        text.style.paintOrder = 'stroke fill';
      } else {
        text.style.webkitTextStroke = '';
      }
      if (currentStyle.position === 'custom') {
        preview.style.alignItems = 'center';
        text.style.position = 'absolute';
        text.style.left = currentStyle.posX + '%';
        text.style.top = currentStyle.posY + '%';
        text.style.transform = 'translate(-50%, -50%)';
      } else {
        text.style.position = 'static';
        text.style.transform = 'none';
        preview.style.alignItems = currentStyle.position === 'top' ? 'flex-start' : currentStyle.position === 'center' ? 'center' : 'flex-end';
      }
      text.style.margin = '8px';
    }

    async function processFile(file) {
      const videoPreview = document.getElementById("videoPreview");
      const previewVideo = document.getElementById("previewVideo");
      previewVideo.src = URL.createObjectURL(file);
      videoPreview.style.display = "block";

      document.getElementById("progressSection").classList.add("active");
      document.getElementById("resultSection").classList.remove("active");
      document.getElementById("errorMsg").textContent = "";

      // Reset progress UI
      document.getElementById('stepCompress').style.display = 'none';
      document.getElementById('stepCompress').className = 'step';
      document.getElementById('stepCompress').querySelector('.step-icon').textContent = 'üì¶';
      document.getElementById('compressDetail').textContent = '';
      document.getElementById('compressProgressFill').style.width = '0%';
      document.getElementById('compressStats').textContent = '';
      document.getElementById('uploadProgressFill').style.width = '0%';
      document.getElementById('uploadStats').textContent = '';
      document.getElementById('stepUpload').className = 'step';
      document.getElementById('stepUpload').querySelector('.step-icon').textContent = '‚¨ÜÔ∏è';
      document.getElementById('uploadDetail').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

      try {
        // Step 1: Compress (if > 50MB)
        const fileToUpload = await compressVideo(file);

        // Step 2: Upload with progress
        setStep("stepUpload", "active");
        document.getElementById("uploadDetail").textContent =
          `${fileToUpload.name} (${(fileToUpload.size / 1024 / 1024).toFixed(1)}MB)`;
        const formData = new FormData();
        formData.append("video", fileToUpload);
        const uploadData = await uploadWithProgress(`${SERVER}/api/upload`, formData);
        currentFilename = uploadData.filename;
        setStep("stepUpload", "done");

        // Step 3: Transcribe
        setStep("stepExtract", "active");
        setStep("stepTranscribe", "active");
        const transcribeRes = await fetch(`${SERVER}/api/transcribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: currentFilename }),
        });
        setStep("stepExtract", "done");

        if (!transcribeRes.ok) {
          const err = await transcribeRes.json();
          throw new Error(err.error || "ÊñáÂ≠óËµ∑„Åì„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }

        const data = await transcribeRes.json();
        setStep("stepTranscribe", "done");
        currentSubtitles = data.subtitles;
        displayResults();

      } catch (error) {
        document.getElementById("errorMsg").textContent = `„Ç®„É©„Éº: ${error.message}`;
        ["stepCompress", "stepUpload", "stepExtract", "stepTranscribe"].forEach((id) => {
          const el = document.getElementById(id);
          if (el && el.classList.contains("active")) setStep(id, "error");
        });
      }
    }

    function displayResults() {
      const list = document.getElementById("subtitleList");
      const fontOptions = Array.from(document.getElementById('styleFont').options)
        .map(o => `<option value="${o.value}">${o.text}</option>`).join('');

      list.innerHTML = currentSubtitles
        .map(
          (sub, i) => `
          <div class="subtitle-item" data-index="${i}">
            <span class="sub-index">${i + 1}</span>
            <input type="number" step="0.1" min="0" value="${sub.start}" onchange="updateSubtitle(${i}, 'start', this.value)" title="ÈñãÂßã(Áßí)">
            <span class="time-sep">‚Üí</span>
            <input type="number" step="0.1" min="0" value="${sub.end}" onchange="updateSubtitle(${i}, 'end', this.value)" title="ÁµÇ‰∫Ü(Áßí)">
            <input type="text" value="${sub.text.replace(/"/g, '&quot;')}" onchange="updateSubtitle(${i}, 'text', this.value)" placeholder="Â≠óÂπï„ÉÜ„Ç≠„Çπ„Éà">
            <div class="seg-pos">
              <span class="seg-pos-label">X</span>
              <input type="number" min="0" max="100" value="${sub.posX ?? ''}" onchange="updateSubtitle(${i}, 'posX', this.value)" placeholder="-">
              <span class="seg-pos-label">Y</span>
              <input type="number" min="0" max="100" value="${sub.posY ?? ''}" onchange="updateSubtitle(${i}, 'posY', this.value)" placeholder="-">
            </div>
            <button class="btn-icon btn-style-toggle" onclick="toggleSegStyle(${i})" title="ÂÄãÂà•„Çπ„Çø„Ç§„É´">üé®</button>
            <button class="btn-icon btn-delete" onclick="deleteSubtitle(${i})" title="ÂâäÈô§">‚úï</button>
          </div>
          <div class="seg-style-row" id="segStyle${i}">
            <div class="seg-field">
              <label>„Éï„Ç©„É≥„Éà</label>
              <select onchange="updateSubtitle(${i}, 'fontFamily', this.value)">
                <option value="">„Éá„Éï„Ç©„É´„Éà</option>
                ${fontOptions}
              </select>
            </div>
            <div class="seg-field">
              <label>„Çµ„Ç§„Ç∫</label>
              <input type="number" min="16" max="400" value="${sub.fontSize ?? ''}" onchange="updateSubtitle(${i}, 'fontSize', this.value)" placeholder="-">
            </div>
            <div class="seg-field">
              <label>ÊñáÂ≠óËâ≤</label>
              <input type="color" value="${sub.fontColor || '#ffffff'}" onchange="updateSubtitle(${i}, 'fontColor', this.value)">
            </div>
            <div class="seg-field">
              <label>ËÉåÊôØËâ≤</label>
              <input type="color" value="${sub.bgColor || '#000000'}" onchange="updateSubtitle(${i}, 'bgColor', this.value)">
            </div>
            <div class="seg-field">
              <label>„Ç¢„Éã„É°</label>
              <select onchange="updateSubtitle(${i}, 'animation', this.value)">
                <option value="">„Éá„Éï„Ç©„É´„Éà</option>
                <option value="fadeIn">„Éï„Çß„Éº„Éâ„Ç§„É≥</option>
                <option value="slideUp">„Çπ„É©„Ç§„Éâ‚Üë</option>
                <option value="slideDown">„Çπ„É©„Ç§„Éâ‚Üì</option>
                <option value="pop">„Éù„ÉÉ„Éó</option>
                <option value="bounce">„Éê„Ç¶„É≥„Çπ</option>
                <option value="typewriter">„Çø„Ç§„Éó</option>
                <option value="none">„Å™„Åó</option>
              </select>
            </div>
          </div>
        `
        )
        .join("");

      // „Çª„Ç∞„É°„É≥„ÉàÂÄãÂà•„Éï„Ç©„É≥„Éà„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÈÅ∏ÊäûÂÄ§„ÇíÂæ©ÂÖÉ
      currentSubtitles.forEach((sub, i) => {
        const row = document.getElementById(`segStyle${i}`);
        if (sub.fontFamily) {
          const sel = row.querySelector('select');
          if (sel) sel.value = sub.fontFamily;
        }
        if (sub.animation) {
          const animSel = row.querySelectorAll('select')[1];
          if (animSel) animSel.value = sub.animation;
        }
      });

      document.getElementById("resultSection").classList.add("active");
    }

    function toggleSegStyle(index) {
      const row = document.getElementById(`segStyle${index}`);
      row.classList.toggle('open');
    }

    function updateSubtitle(index, field, value) {
      if (field === 'start' || field === 'end') {
        currentSubtitles[index][field] = parseFloat(value);
      } else if (field === 'posX' || field === 'posY' || field === 'fontSize') {
        if (value === '' || value === undefined) {
          delete currentSubtitles[index][field];
        } else {
          currentSubtitles[index][field] = parseInt(value);
        }
      } else if (field === 'fontFamily' || field === 'fontColor' || field === 'bgColor' || field === 'animation') {
        if (!value || value === '') {
          delete currentSubtitles[index][field];
        } else {
          currentSubtitles[index][field] = value;
        }
      } else {
        currentSubtitles[index][field] = value;
      }
    }

    function deleteSubtitle(index) {
      currentSubtitles.splice(index, 1);
      displayResults();
    }

    function addSubtitle() {
      const lastEnd = currentSubtitles.length > 0
        ? currentSubtitles[currentSubtitles.length - 1].end
        : 0;
      currentSubtitles.push({
        start: lastEnd,
        end: lastEnd + 3,
        text: ""
      });
      displayResults();
      // Êñ∞„Åó„ÅÑË°å„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„Å´„Éï„Ç©„Éº„Ç´„Çπ
      setTimeout(() => {
        const inputs = document.querySelectorAll('.subtitle-item:last-child input[type="text"]');
        if (inputs.length) inputs[0].focus();
      }, 50);
    }

    async function saveSubtitles() {
      const res = await fetch(`${SERVER}/api/save-subtitles`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, subtitles: currentSubtitles }),
      });
      if (!res.ok) throw new Error("Â≠óÂπï„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó");
    }

    async function saveStyle() {
      const res = await fetch(`${SERVER}/api/save-style`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, style: currentStyle }),
      });
      if (!res.ok) throw new Error("„Çπ„Çø„Ç§„É´„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó");
    }

    async function saveAudioTracks() {
      if (audioTracks.length === 0) return;
      const res = await fetch(`${SERVER}/api/save-audio`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, audioTracks }),
      });
      if (!res.ok) throw new Error("„Ç™„Éº„Éá„Ç£„Ç™„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó");
    }

    async function saveEditSettings() {
      const res = await fetch(`${SERVER}/api/save-edit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, editSettings }),
      });
      if (!res.ok) throw new Error("Á∑®ÈõÜË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó");
    }

    async function saveAll() {
      try {
        await Promise.all([saveSubtitles(), saveStyle(), saveAudioTracks(), saveEditSettings()]);
        showToast();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `„Ç®„É©„Éº: ${error.message}`;
      }
    }

    async function saveAndOpenStudio() {
      const w = window.open("http://localhost:3000/MyComp", "_blank");
      try {
        await Promise.all([saveSubtitles(), saveStyle(), saveAudioTracks(), saveEditSettings()]);
      } catch (e) { }
      if (w) w.focus();
    }

    // Audio track management
    async function uploadAudioFile(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("audio", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-audio`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó");
        const data = await res.json();
        audioTracks.push({ filename: data.filename, startTime: 0, volume: 0.5 });
        displayAudioTracks();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `„Ç®„É©„Éº: ${error.message}`;
      }
      input.value = '';
    }

    function displayAudioTracks() {
      const list = document.getElementById('audioTrackList');
      list.innerHTML = audioTracks.map((t, i) => `
        <div class="audio-item">
          <span class="audio-name">üéµ ${t.filename}</span>
          <label>ÈñãÂßã(s)</label>
          <input type="number" value="${t.startTime}" step="0.1" min="0" onchange="audioTracks[${i}].startTime=parseFloat(this.value)">
          <label>Èü≥Èáè</label>
          <input type="number" value="${t.volume}" step="0.1" min="0" max="1" onchange="audioTracks[${i}].volume=parseFloat(this.value)">
          <button class="btn-icon btn-delete" onclick="audioTracks.splice(${i},1); displayAudioTracks()" title="ÂâäÈô§">‚úï</button>
        </div>
      `).join('');
    }

    // Edit settings
    function updateEditSettings() {
      const startVal = document.getElementById('trimStart').value;
      const endVal = document.getElementById('trimEnd').value;
      editSettings.trim.startTime = parseFloat(startVal) || 0;
      editSettings.trim.endTime = endVal ? parseFloat(endVal) : null;
      editSettings.transition.fadeIn = parseFloat(document.getElementById('fadeIn').value) || 0;
      editSettings.transition.fadeOut = parseFloat(document.getElementById('fadeOut').value) || 0;
      const speed = parseFloat(document.getElementById('playbackSpeed').value) || 1;
      editSettings.speedSections = [{ start: 0, end: 9999, speed }];
    }

    function setSpeed(speed) {
      document.getElementById('playbackSpeed').value = speed;
      updateEditSettings();
      updateSpeedPresets();
    }

    function updateSpeedPresets() {
      const speed = parseFloat(document.getElementById('playbackSpeed').value);
      document.querySelectorAll('.speed-preset-btn').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.textContent) === speed);
      });
    }

    async function uploadMergeVideo(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("video", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-video`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó");
        const data = await res.json();
        editSettings.additionalVideos.push(data.filename);
        displayMergeVideos();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `„Ç®„É©„Éº: ${error.message}`;
      }
      input.value = '';
    }

    function displayMergeVideos() {
      const list = document.getElementById('mergeVideoList');
      list.innerHTML = editSettings.additionalVideos.map((v, i) => `
        <div class="merge-item">
          <span class="merge-name">üé¨ ${v}</span>
          <button class="btn-icon btn-delete" onclick="editSettings.additionalVideos.splice(${i},1); displayMergeVideos()" title="ÂâäÈô§">‚úï</button>
        </div>
      `).join('');
    }

    // Image overlays
    async function uploadOverlayImage(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("image", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-image`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó");
        const data = await res.json();
        editSettings.imageOverlays.push({
          filename: data.filename,
          startTime: 0,
          endTime: 5,
          posX: 50,
          posY: 50,
          width: 200,
          opacity: 1,
          animation: "fadeIn"
        });
        displayOverlays();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `„Ç®„É©„Éº: ${error.message}`;
      }
      input.value = '';
    }

    function displayOverlays() {
      const list = document.getElementById('overlayList');
      list.innerHTML = editSettings.imageOverlays.map((o, i) => `
        <div class="overlay-item">
          <span class="overlay-name">üñºÔ∏è ${o.filename.slice(0, 15)}</span>
          <label>ÈñãÂßã</label><input type="number" value="${o.startTime}" step="0.1" min="0" onchange="editSettings.imageOverlays[${i}].startTime=parseFloat(this.value)">
          <label>ÁµÇ‰∫Ü</label><input type="number" value="${o.endTime}" step="0.1" min="0" onchange="editSettings.imageOverlays[${i}].endTime=parseFloat(this.value)">
          <label>X%</label><input type="number" value="${o.posX}" min="0" max="100" onchange="editSettings.imageOverlays[${i}].posX=parseInt(this.value)">
          <label>Y%</label><input type="number" value="${o.posY}" min="0" max="100" onchange="editSettings.imageOverlays[${i}].posY=parseInt(this.value)">
          <label>ÂπÖ</label><input type="number" value="${o.width}" min="10" max="1000" step="10" onchange="editSettings.imageOverlays[${i}].width=parseInt(this.value)">
          <label>ÈÄèÊòéÂ∫¶</label><input type="number" value="${o.opacity}" step="0.1" min="0" max="1" onchange="editSettings.imageOverlays[${i}].opacity=parseFloat(this.value)">
          <select onchange="editSettings.imageOverlays[${i}].animation=this.value">
            <option value="none" ${o.animation === 'none' ? 'selected' : ''}>„Å™„Åó</option>
            <option value="fadeIn" ${o.animation === 'fadeIn' ? 'selected' : ''}>„Éï„Çß„Éº„Éâ</option>
            <option value="pop" ${o.animation === 'pop' ? 'selected' : ''}>„Éù„ÉÉ„Éó</option>
          </select>
          <button class="btn-icon btn-delete" onclick="editSettings.imageOverlays.splice(${i},1); displayOverlays()" title="ÂâäÈô§">‚úï</button>
        </div>
      `).join('');
    }

    // Filters
    function updateFilters() {
      const f = editSettings.filters;
      f.brightness = parseInt(document.getElementById('filterBrightness').value);
      f.contrast = parseInt(document.getElementById('filterContrast').value);
      f.saturate = parseInt(document.getElementById('filterSaturate').value);
      f.sepia = parseInt(document.getElementById('filterSepia').value);
      f.grayscale = parseInt(document.getElementById('filterGrayscale').value);
      f.hueRotate = parseInt(document.getElementById('filterHue').value);
      f.blur = parseFloat(document.getElementById('filterBlur').value);
      // Update labels
      document.getElementById('filterBrightnessVal').textContent = f.brightness + '%';
      document.getElementById('filterContrastVal').textContent = f.contrast + '%';
      document.getElementById('filterSaturateVal').textContent = f.saturate + '%';
      document.getElementById('filterSepiaVal').textContent = f.sepia + '%';
      document.getElementById('filterGrayscaleVal').textContent = f.grayscale + '%';
      document.getElementById('filterHueVal').textContent = f.hueRotate + '¬∞';
      document.getElementById('filterBlurVal').textContent = f.blur + 'px';
      // Apply to preview video
      applyPreviewFilter();
    }

    function resetFilters() {
      document.getElementById('filterBrightness').value = 100;
      document.getElementById('filterContrast').value = 100;
      document.getElementById('filterSaturate').value = 100;
      document.getElementById('filterSepia').value = 0;
      document.getElementById('filterGrayscale').value = 0;
      document.getElementById('filterHue').value = 0;
      document.getElementById('filterBlur').value = 0;
      updateFilters();
    }

    function applyPreviewFilter() {
      const video = document.getElementById('previewVideo');
      if (!video) return;
      const f = editSettings.filters;
      const parts = [];
      if (f.brightness !== 100) parts.push(`brightness(${f.brightness}%)`);
      if (f.contrast !== 100) parts.push(`contrast(${f.contrast}%)`);
      if (f.saturate !== 100) parts.push(`saturate(${f.saturate}%)`);
      if (f.sepia > 0) parts.push(`sepia(${f.sepia}%)`);
      if (f.grayscale > 0) parts.push(`grayscale(${f.grayscale}%)`);
      if (f.hueRotate > 0) parts.push(`hue-rotate(${f.hueRotate}deg)`);
      if (f.blur > 0) parts.push(`blur(${f.blur}px)`);
      video.style.filter = parts.join(' ') || 'none';
    }

    // Ken Burns
    function updateKenBurns() {
      const kb = editSettings.kenBurns;
      kb.enabled = document.getElementById('kbToggle').classList.contains('active');
      kb.startScale = parseFloat(document.getElementById('kbStartScale').value) || 1;
      kb.endScale = parseFloat(document.getElementById('kbEndScale').value) || 1;
      kb.startX = parseFloat(document.getElementById('kbStartX').value) || 0;
      kb.endX = parseFloat(document.getElementById('kbEndX').value) || 0;
      kb.startY = parseFloat(document.getElementById('kbStartY').value) || 0;
      kb.endY = parseFloat(document.getElementById('kbEndY').value) || 0;
      document.getElementById('kbLabel').textContent = kb.enabled ? 'ON' : 'OFF';
      document.getElementById('kbControls').style.display = kb.enabled ? '' : 'none';
    }

    function setKBPreset(ss, es, sx, ex, sy, ey) {
      document.getElementById('kbStartScale').value = ss;
      document.getElementById('kbEndScale').value = es;
      document.getElementById('kbStartX').value = sx;
      document.getElementById('kbEndX').value = ex;
      document.getElementById('kbStartY').value = sy;
      document.getElementById('kbEndY').value = ey;
      if (!document.getElementById('kbToggle').classList.contains('active')) {
        document.getElementById('kbToggle').classList.add('active');
      }
      updateKenBurns();
    }

    // Free Telop
    function addTelop() {
      editSettings.textOverlays.push({
        text: "„ÉÜ„É≠„ÉÉ„Éó",
        startTime: 0,
        endTime: 5,
        posX: 50,
        posY: 50,
        fontSize: 48,
        fontFamily: "Noto Sans CJK JP",
        fontColor: "#ffffff",
        bgColor: "#000000",
        bgOpacity: 0.7,
        bold: true,
        animation: "fadeIn"
      });
      displayTelops();
    }

    function displayTelops() {
      const fontOptions = Array.from(document.getElementById('styleFont').options)
        .map(o => `<option value="${o.value}">${o.text}</option>`).join('');

      const list = document.getElementById('telopList');
      list.innerHTML = editSettings.textOverlays.map((t, i) => `
        <div class="telop-item">
          <div class="telop-top">
            <input type="text" value="${t.text.replace(/"/g, '&quot;')}" onchange="editSettings.textOverlays[${i}].text=this.value" placeholder="„ÉÜ„Ç≠„Çπ„Éà">
            <label>ÈñãÂßã</label>
            <input type="number" value="${t.startTime}" step="0.1" min="0" onchange="editSettings.textOverlays[${i}].startTime=parseFloat(this.value)">
            <label>ÁµÇ‰∫Ü</label>
            <input type="number" value="${t.endTime}" step="0.1" min="0" onchange="editSettings.textOverlays[${i}].endTime=parseFloat(this.value)">
            <label>X%</label>
            <input type="number" value="${t.posX}" min="0" max="100" onchange="editSettings.textOverlays[${i}].posX=parseInt(this.value)">
            <label>Y%</label>
            <input type="number" value="${t.posY}" min="0" max="100" onchange="editSettings.textOverlays[${i}].posY=parseInt(this.value)">
            <button class="btn-icon btn-style-toggle" onclick="document.getElementById('telopStyle${i}').classList.toggle('open')" title="„Çπ„Çø„Ç§„É´">üé®</button>
            <button class="btn-icon btn-delete" onclick="editSettings.textOverlays.splice(${i},1); displayTelops()" title="ÂâäÈô§">‚úï</button>
          </div>
          <div class="telop-style" id="telopStyle${i}">
            <div class="tsf"><label>„Éï„Ç©„É≥„Éà</label>
              <select onchange="editSettings.textOverlays[${i}].fontFamily=this.value">
                ${fontOptions}
              </select>
            </div>
            <div class="tsf"><label>„Çµ„Ç§„Ç∫</label>
              <input type="number" value="${t.fontSize}" min="12" max="200" onchange="editSettings.textOverlays[${i}].fontSize=parseInt(this.value)">
            </div>
            <div class="tsf"><label>ÊñáÂ≠ó</label>
              <input type="color" value="${t.fontColor}" onchange="editSettings.textOverlays[${i}].fontColor=this.value">
            </div>
            <div class="tsf"><label>ËÉåÊôØ</label>
              <input type="color" value="${t.bgColor}" onchange="editSettings.textOverlays[${i}].bgColor=this.value">
            </div>
            <div class="tsf"><label>ÈÄèÊòéÂ∫¶</label>
              <input type="number" value="${t.bgOpacity}" step="0.1" min="0" max="1" style="width:45px" onchange="editSettings.textOverlays[${i}].bgOpacity=parseFloat(this.value)">
            </div>
            <div class="tsf"><label>„Ç¢„Éã„É°</label>
              <select onchange="editSettings.textOverlays[${i}].animation=this.value">
                <option value="none" ${t.animation === 'none' ? 'selected' : ''}>„Å™„Åó</option>
                <option value="fadeIn" ${t.animation === 'fadeIn' ? 'selected' : ''}>„Éï„Çß„Éº„Éâ</option>
                <option value="slideUp" ${t.animation === 'slideUp' ? 'selected' : ''}>„Çπ„É©„Ç§„Éâ</option>
                <option value="pop" ${t.animation === 'pop' ? 'selected' : ''}>„Éù„ÉÉ„Éó</option>
                <option value="typewriter" ${t.animation === 'typewriter' ? 'selected' : ''}>„Çø„Ç§„Éó</option>
              </select>
            </div>
          </div>
        </div>
      `).join('');

      // „Éï„Ç©„É≥„ÉàÂÄ§Âæ©ÂÖÉ
      editSettings.textOverlays.forEach((t, i) => {
        const sel = document.querySelector(`#telopStyle${i} select`);
        if (sel) sel.value = t.fontFamily;
      });
    }

    // Export: Preview (5ÁßíÈñì„ÅÆÂÆü„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Éó„É¨„Éì„É•„Éº)
    async function startPreview() {
      const btn = document.getElementById('previewBtn');
      const status = document.getElementById('renderStatus');
      const video = document.getElementById('previewVideo');
      if (!currentFilename) { alert('ÂÖà„Å´ÂãïÁîª„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

      btn.disabled = true;
      btn.textContent = '‚è≥ „Éó„É¨„Éì„É•„ÉºÁîüÊàê‰∏≠...';
      status.textContent = 'üîÑ „Çµ„Éº„Éê„Éº„Åß„Éó„É¨„Éì„É•„Éº„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞‰∏≠...';

      try {
        const resp = await fetch(`${SERVER}/api/preview`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: currentFilename,
            currentTime: video ? video.currentTime : 0,
            subtitles: currentSubtitles,
            subtitleStyle: currentStyle,
            editSettings
          })
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.error || '„Éó„É¨„Éì„É•„ÉºÁîüÊàê„Å´Â§±Êïó');
        }

        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        video.src = url;
        video.play();
        status.textContent = '‚úÖ „Éó„É¨„Éì„É•„ÉºÁîüÊàêÂÆå‰∫ÜÔºÅÔºàÂÆüÈöõ„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÁµêÊûú„Å®Âêå„ÅòË¶ã„ÅüÁõÆ„Åß„ÅôÔºâ';
      } catch (e) {
        status.textContent = `‚ùå „Éó„É¨„Éì„É•„Éº„Ç®„É©„Éº: ${e.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üëÅÔ∏è „Éó„É¨„Éì„É•„Éº (5Áßí)';
      }
    }

    // Export: MP4 Render
    async function startRender() {
      const btn = document.getElementById('renderBtn');
      const status = document.getElementById('renderStatus');
      const result = document.getElementById('renderResult');
      btn.disabled = true;
      btn.textContent = '\u23f3 \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d...';
      status.className = 'render-status';
      status.textContent = '\u203b \u8a2d\u5b9a\u3092\u4fdd\u5b58\u4e2d...';
      result.innerHTML = '';
      try {
        // „Çπ„ÉÜ„ÉÉ„Éó1: Ë®≠ÂÆö‰øùÂ≠ò
        try { await saveSubtitles(); } catch (e) { throw new Error('Â≠óÂπï‰øùÂ≠òÂ§±Êïó: ' + e.message); }
        try { await saveStyle(); } catch (e) { throw new Error('„Çπ„Çø„Ç§„É´‰øùÂ≠òÂ§±Êïó: ' + e.message); }
        try { await saveAudioTracks(); } catch (e) { throw new Error('„Ç™„Éº„Éá„Ç£„Ç™‰øùÂ≠òÂ§±Êïó: ' + e.message); }
        try { await saveEditSettings(); } catch (e) { throw new Error('Á∑®ÈõÜË®≠ÂÆö‰øùÂ≠òÂ§±Êïó: ' + e.message); }

        // „Çπ„ÉÜ„ÉÉ„Éó2: „É¨„É≥„ÉÄ„É™„É≥„Ç∞„Ç∏„Éß„ÉñÈñãÂßã
        status.textContent = '\u203b \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u958b\u59cb\u4e2d...';
        const res = await fetch(`${SERVER}/api/render`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: currentFilename }),
        });
        if (!res.ok) {
          const text = await res.text();
          let errMsg;
          try { errMsg = JSON.parse(text).error; } catch { errMsg = text; }
          throw new Error(errMsg || `HTTP ${res.status}`);
        }
        const data = await res.json();
        const jobId = data.jobId;
        if (!jobId) throw new Error('„Ç∏„Éß„ÉñID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');

        // „Çπ„ÉÜ„ÉÉ„Éó3: „Çπ„ÉÜ„Éº„Çø„Çπ„Éù„Éº„É™„É≥„Ç∞
        status.textContent = '\u203b FFmpeg\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d... \u6570\u5206\u304b\u304b\u308a\u307e\u3059';
        let dots = 0;
        const pollInterval = setInterval(async () => {
          dots = (dots + 1) % 4;
          status.textContent = '\u203b FFmpeg\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d' + '.'.repeat(dots + 1);
        }, 1000);

        const jobResult = await new Promise((resolve, reject) => {
          const check = async () => {
            try {
              const statusRes = await fetch(`${SERVER}/api/render-status/${jobId}`);
              const job = await statusRes.json();
              if (job.status === 'done') {
                clearInterval(pollInterval);
                resolve(job);
              } else if (job.status === 'error') {
                clearInterval(pollInterval);
                reject(new Error(job.error || '„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Å´Â§±Êïó'));
              } else {
                setTimeout(check, 3000);
              }
            } catch (e) {
              setTimeout(check, 5000);
            }
          };
          setTimeout(check, 3000);
        });

        status.className = 'render-status success';
        status.textContent = '\u2705 \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u5b8c\u4e86\uff01';
        result.innerHTML = `<a class="download-link" href="${SERVER}/${jobResult.path}" download="${jobResult.filename}">\u2b07 ${jobResult.filename} \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9</a>`;
      } catch (error) {
        status.className = 'render-status error';
        status.textContent = `\u274c \u30a8\u30e9\u30fc: ${error.message}`;
        console.error('render error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = '\ud83d\udce6 \u52d5\u753b\u3092\u66f8\u304d\u51fa\u3057';
      }
    }

    // Export: SRT/VTT
    async function exportSubtitles() {
      const format = document.getElementById('exportSubFormat').value;
      try {
        const res = await fetch(`${SERVER}/api/export-subtitles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subtitles: currentSubtitles, format }),
        });
        if (!res.ok) throw new Error('\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u5931\u6557');
        const text = await res.text();
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const baseName = currentFilename.replace(/\.[^.]+$/, '');
        a.href = url;
        a.download = `${baseName}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast();
      } catch (error) {
        document.getElementById('errorMsg').textContent = `\u30a8\u30e9\u30fc: ${error.message}`;
      }
    }

    // Export: Thumbnail
    async function generateThumbnail() {
      const time = parseFloat(document.getElementById('thumbTime').value) || 0;
      const result = document.getElementById('thumbResult');
      result.innerHTML = '<div style="color:#888; font-size:12px; margin-top:8px">\u751f\u6210\u4e2d...</div>';
      try {
        const res = await fetch(`${SERVER}/api/thumbnail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: currentFilename, time }),
        });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error); }
        const data = await res.json();
        result.innerHTML = `
          <div class="thumb-preview">
            <img src="${SERVER}/${data.path}?t=${Date.now()}" alt="\u30b5\u30e0\u30cd\u30a4\u30eb">
          </div>
          <a class="download-link" href="${SERVER}/${data.path}" download="${data.filename}">\u2b07 ${data.filename} \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9</a>
        `;
      } catch (error) {
        result.innerHTML = `<div style="color:#ef4444; font-size:12px; margin-top:8px">\u274c ${error.message}</div>`;
      }
    }

    // Project Save/Load
    function downloadProject() {
      const project = {
        version: 1,
        filename: currentFilename,
        subtitles: currentSubtitles,
        style: currentStyle,
        audioTracks: audioTracks,
        editSettings: editSettings
      };
      const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const baseName = currentFilename ? currentFilename.replace(/\.[^.]+$/, '') : 'project';
      a.href = url;
      a.download = `${baseName}_project.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast();
    }

    function loadProject(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const project = JSON.parse(e.target.result);
          if (project.subtitles) currentSubtitles = project.subtitles;
          if (project.style) currentStyle = project.style;
          if (project.audioTracks) audioTracks = project.audioTracks;
          if (project.editSettings) editSettings = project.editSettings;
          if (project.filename) currentFilename = project.filename;
          takeSnapshot();
          refreshUI();
          showToast();
        } catch (err) {
          document.getElementById('errorMsg').textContent = 'JSON\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557: ' + err.message;
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', function (e) {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (!mod) return;

      if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        saveAll();
      } else if (e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
        e.preventDefault();
        redo();
      } else if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        downloadProject();
      } else if (e.key === 'o' || e.key === 'O') {
        e.preventDefault();
        document.getElementById('projectFileInput').click();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        saveAndOpenStudio();
      }
    });

    // Wire takeSnapshot into key changes
    const origSaveAll = saveAll;
    saveAll = async function () {
      takeSnapshot();
      return origSaveAll();
    };

    function showToast() {
      const toast = document.getElementById("saveToast");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }
  </script>
</body>

</html>