<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•å­—å¹•ãƒ„ãƒ¼ãƒ«</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Serif+JP:wght@400;700&family=M+PLUS+1p:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Kosugi+Maru&family=Sawarabi+Gothic&family=Sawarabi+Mincho&family=Zen+Kaku+Gothic+New:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&family=Zen+Old+Mincho:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Kiwi+Maru:wght@400;700&family=Hachi+Maru+Pop&family=Yusei+Magic&family=Dela+Gothic+One&family=Reggae+One&family=RocknRoll+One&family=Stick&family=DotGothic16&family=Potta+One&family=Rampart+One&family=Train+One&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=Montserrat:wght@400;700&family=Lato:wght@400;700&family=Inter:wght@400;700&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    h1 {
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #1d1d1f;
      letter-spacing: -0.3px;
    }

    .subtitle {
      text-align: center;
      color: #86868b;
      margin-bottom: 36px;
      font-size: 13px;
      font-weight: 400;
    }

    /* Upload Area */
    .upload-area {
      border: 1.5px dashed #c7c7cc;
      border-radius: 10px;
      padding: 52px 32px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: #fff;
    }

    .upload-area:hover,
    .upload-area.dragover {
      border-color: #3478f6;
      background: #f0f5ff;
    }

    .upload-icon {
      font-size: 36px;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .upload-text {
      font-size: 15px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 6px;
    }

    .upload-hint {
      font-size: 12px;
      color: #86868b;
    }

    .upload-area input[type="file"] {
      display: none;
    }

    /* Progress */
    .progress-section {
      margin-top: 28px;
      display: none;
    }

    .progress-section.active {
      display: block;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 6px;
      background: #fff;
      transition: background 0.2s;
      border: 1px solid #e8e8ed;
    }

    .step.active {
      background: #f0f5ff;
      border-color: rgba(52, 120, 246, 0.25);
    }

    .step.done {
      background: #f0faf4;
      border-color: rgba(48, 164, 108, 0.25);
    }

    .step.error {
      background: #fef5f5;
      border-color: rgba(210, 70, 70, 0.25);
    }

    .step-icon {
      font-size: 20px;
      width: 32px;
      text-align: center;
    }

    .step-text {
      flex: 1;
    }

    .step-title {
      font-weight: 600;
      font-size: 13px;
      color: #1d1d1f;
    }

    .step-detail {
      font-size: 11px;
      color: #86868b;
      margin-top: 2px;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e8e8ed;
      border-top: 2px solid #3478f6;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Result */
    .result-section {
      margin-top: 28px;
      display: none;
    }

    .result-section.active {
      display: block;
    }

    .result-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e8e8ed;
    }

    .result-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 14px;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subtitle-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .subtitle-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid #f0f0f2;
      font-size: 13px;
    }

    .subtitle-item .sub-index {
      color: #aeaeb2;
      font-size: 11px;
      min-width: 22px;
      text-align: center;
      font-weight: 500;
    }

    .subtitle-item input[type="text"] {
      flex: 1;
      min-width: 0;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #1d1d1f;
      padding: 7px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: border-color 0.15s;
    }

    .subtitle-item input[type="text"]:focus {
      outline: none;
      border-color: #3478f6;
      background: #fff;
    }

    .subtitle-item input[type="number"] {
      width: 54px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #3478f6;
      padding: 7px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .subtitle-item input[type="number"]:focus {
      outline: none;
      border-color: #3478f6;
      background: #fff;
    }

    .seg-pos {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .seg-pos-label {
      font-size: 10px;
      color: #aeaeb2;
    }

    .seg-pos input {
      width: 38px !important;
      font-size: 10px !important;
      padding: 5px 2px !important;
      color: #5856d6 !important;
    }

    .btn-style-toggle {
      background: #f0f0f2;
      color: #5856d6;
    }

    .btn-style-toggle:hover {
      background: #e8e8ed;
    }

    .seg-style-row {
      display: none;
      grid-column: 1 / -1;
      background: #fafafa;
      border: 1px solid #e8e8ed;
      border-radius: 6px;
      padding: 8px 10px;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: -2px 0 4px 22px;
    }

    .seg-style-row.open {
      display: flex;
    }

    .seg-style-row label {
      font-size: 10px;
      color: #86868b;
      margin-right: 2px;
    }

    .seg-style-row select {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 4px;
      color: #1d1d1f;
      padding: 4px 6px;
      font-size: 11px;
      max-width: 120px;
    }

    .seg-style-row input[type="number"] {
      width: 42px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 4px;
      color: #1d1d1f;
      padding: 4px 4px;
      font-size: 11px;
      text-align: center;
    }

    .seg-style-row input[type="color"] {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: transparent;
      padding: 0;
    }

    .seg-style-row .seg-field {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    /* â”€â”€ Section Cards (shared) â”€â”€ */
    .audio-card,
    .edit-card,
    .visual-card,
    .telop-card,
    .export-card,
    .style-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #e8e8ed;
      margin-top: 12px;
    }

    /* Section titles â€” unified muted style */
    .audio-title,
    .edit-title,
    .visual-title,
    .visual-title.overlay,
    .visual-title.filter,
    .visual-title.kenburns,
    .telop-title,
    .export-title,
    .style-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 14px;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Audio Tracks */
    .audio-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid #f0f0f2;
      font-size: 12px;
    }

    .audio-item .audio-name {
      flex: 1;
      color: #636366;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .audio-item input[type="number"] {
      width: 52px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #30a46c;
      padding: 5px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .audio-item label {
      font-size: 10px;
      color: #86868b;
    }

    .audio-upload-btn {
      background: #fafafa;
      color: #30a46c;
      width: 100%;
      height: 34px;
      border-radius: 6px;
      border: 1px dashed #c7c7cc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: border-color 0.15s;
    }

    .audio-upload-btn:hover {
      border-color: #30a46c;
    }

    /* Edit Section */
    .edit-section {
      margin-bottom: 18px;
    }

    .edit-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #636366;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .edit-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .edit-field {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .edit-field label {
      font-size: 11px;
      color: #86868b;
    }

    .edit-field input[type="number"],
    .edit-field select {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #b45309;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      width: 66px;
      text-align: center;
    }

    .edit-field input:focus,
    .edit-field select:focus {
      outline: none;
      border-color: #b45309;
      background: #fff;
    }

    .edit-hint {
      font-size: 11px;
      color: #aeaeb2;
      margin-top: 4px;
    }

    .merge-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f2;
      font-size: 12px;
    }

    .merge-item .merge-name {
      flex: 1;
      color: #636366;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .merge-upload-btn {
      background: #fafafa;
      color: #b45309;
      width: 100%;
      height: 34px;
      border-radius: 6px;
      border: 1px dashed #c7c7cc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: border-color 0.15s;
    }

    .merge-upload-btn:hover {
      border-color: #b45309;
    }

    .speed-presets {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }

    .speed-preset-btn {
      padding: 5px 10px;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      background: #f5f5f7;
      color: #86868b;
      font-size: 11px;
      cursor: pointer;
      font-family: 'SF Mono', 'Fira Code', monospace;
      transition: all 0.15s;
    }

    .speed-preset-btn:hover {
      border-color: #b45309;
      color: #b45309;
    }

    .speed-preset-btn.active {
      background: #b45309;
      color: #fff;
      border-color: #b45309;
      font-weight: 600;
    }

    /* Filter / Color */
    .filter-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .filter-item label {
      font-size: 11px;
      color: #636366;
      display: flex;
      justify-content: space-between;
    }

    .filter-item label span {
      color: #0e7490;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 10px;
    }

    .filter-item input[type="range"] {
      width: 100%;
      accent-color: #0e7490;
      height: 4px;
    }

    .overlay-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 0;
      border-bottom: 1px solid #f0f0f2;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .overlay-item .overlay-name {
      color: #5856d6;
      min-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .overlay-item input[type="number"],
    .overlay-item select {
      width: 48px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 4px;
      color: #1d1d1f;
      padding: 4px 3px;
      font-size: 10px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .overlay-item label {
      font-size: 10px;
      color: #86868b;
    }

    .overlay-upload-btn {
      background: #fafafa;
      color: #5856d6;
      width: 100%;
      height: 34px;
      border-radius: 6px;
      border: 1px dashed #c7c7cc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: border-color 0.15s;
    }

    .overlay-upload-btn:hover {
      border-color: #5856d6;
    }

    .kb-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .kb-field {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kb-field label {
      font-size: 11px;
      color: #86868b;
      min-width: 38px;
    }

    .kb-field input {
      width: 58px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #a3366b;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .kb-field input:focus {
      outline: none;
      border-color: #a3366b;
      background: #fff;
    }

    .btn-reset {
      background: #f5f5f7;
      color: #86868b;
      border: 1px solid #d2d2d7;
      padding: 5px 12px;
      border-radius: 5px;
      font-size: 11px;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.15s;
    }

    .btn-reset:hover {
      color: #0e7490;
      border-color: #0e7490;
    }

    /* Telop */
    .telop-item {
      background: #fafafa;
      border: 1px solid #e8e8ed;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 6px;
    }

    .telop-top {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .telop-top input[type="text"] {
      flex: 1;
      min-width: 120px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #b45309;
      padding: 7px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .telop-top input[type="text"]:focus {
      outline: none;
      border-color: #b45309;
      background: #fff;
    }

    .telop-top input[type="number"] {
      width: 52px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #1d1d1f;
      padding: 5px 4px;
      font-size: 11px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .telop-top label {
      font-size: 10px;
      color: #86868b;
    }

    .telop-style {
      display: none;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e8e8ed;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .telop-style.open {
      display: flex;
    }

    .telop-style select,
    .telop-style input[type="number"] {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 4px;
      color: #1d1d1f;
      padding: 4px 6px;
      font-size: 11px;
    }

    .telop-style select {
      max-width: 110px;
    }

    .telop-style input[type="number"] {
      width: 40px;
      text-align: center;
    }

    .telop-style input[type="color"] {
      width: 26px;
      height: 26px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: transparent;
      padding: 0;
    }

    .telop-style label {
      font-size: 10px;
      color: #86868b;
    }

    .telop-style .tsf {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .telop-add-btn {
      background: #fafafa;
      color: #b45309;
      width: 100%;
      height: 36px;
      border-radius: 6px;
      border: 1px dashed #c7c7cc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: border-color 0.15s;
    }

    .telop-add-btn:hover {
      border-color: #b45309;
    }

    /* Export Section */
    .export-section {
      margin-bottom: 18px;
    }

    .export-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #636366;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.15s;
      border: none;
    }

    .export-btn.render {
      background: #3478f6;
      color: white;
    }

    .export-btn.render:hover {
      background: #2563eb;
    }

    .export-btn.render:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .export-btn.sub {
      background: #f0faf4;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .export-btn.sub:hover {
      border-color: #15803d;
    }

    .export-btn.thumb {
      background: #f0f0ff;
      color: #5856d6;
      border: 1px solid #c7c7f0;
    }

    .export-btn.thumb:hover {
      border-color: #5856d6;
    }

    .export-field input[type="number"] {
      width: 60px;
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #5856d6;
      padding: 7px 6px;
      font-size: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      text-align: center;
    }

    .export-field label {
      font-size: 11px;
      color: #86868b;
    }

    .export-field select {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #15803d;
      padding: 7px 10px;
      font-size: 12px;
    }

    .export-field {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .render-status {
      font-size: 12px;
      color: #86868b;
      margin-top: 8px;
    }

    .render-status.success {
      color: #15803d;
    }

    .render-status.error {
      color: #dc2626;
    }

    .thumb-preview {
      margin-top: 10px;
      max-width: 300px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e8e8ed;
    }

    .thumb-preview img {
      width: 100%;
      display: block;
    }

    .download-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #15803d;
      font-size: 12px;
      text-decoration: none;
      margin-top: 6px;
    }

    .download-link:hover {
      text-decoration: underline;
    }

    /* Utility Bar */
    .utility-bar {
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      border: 1px solid #e8e8ed;
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .utility-title {
      font-size: 12px;
      font-weight: 600;
      color: #86868b;
      margin-right: 6px;
    }

    .util-btn {
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.15s;
      border: 1px solid #d2d2d7;
      background: #f5f5f7;
      color: #636366;
    }

    .util-btn:hover {
      color: #1d1d1f;
      border-color: #aeaeb2;
    }

    .util-btn:disabled {
      opacity: 0.25;
      cursor: not-allowed;
    }

    .util-btn.undo,
    .util-btn.redo {
      color: #3478f6;
    }

    .util-btn.undo:hover,
    .util-btn.redo:hover {
      border-color: #3478f6;
    }

    .util-btn.project-save {
      color: #15803d;
    }

    .util-btn.project-save:hover {
      border-color: #15803d;
    }

    .util-btn.project-load {
      color: #b45309;
    }

    .util-btn.project-load:hover {
      border-color: #b45309;
    }

    .util-btn.shortcut-help {
      color: #5856d6;
    }

    .util-btn.shortcut-help:hover {
      border-color: #5856d6;
    }

    .util-sep {
      width: 1px;
      height: 20px;
      background: #e8e8ed;
      margin: 0 2px;
    }

    .undo-count {
      font-size: 10px;
      color: #aeaeb2;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    .shortcut-panel {
      display: none;
      background: #fff;
      border: 1px solid #e8e8ed;
      border-radius: 8px;
      padding: 14px 16px;
      margin-top: 6px;
      font-size: 11px;
    }

    .shortcut-panel.open {
      display: block;
    }

    .shortcut-panel table {
      width: 100%;
      border-collapse: collapse;
    }

    .shortcut-panel td {
      padding: 3px 8px;
      border-bottom: 1px solid #f0f0f2;
    }

    .shortcut-panel td:first-child {
      color: #5856d6;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-weight: 600;
      white-space: nowrap;
    }

    .shortcut-panel td:last-child {
      color: #86868b;
    }

    .time-sep {
      color: #aeaeb2;
      font-size: 11px;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .btn-delete {
      background: #fef2f2;
      color: #dc2626;
    }

    .btn-delete:hover {
      background: #fee2e2;
    }

    .btn-add {
      background: #fafafa;
      color: #3478f6;
      width: 100%;
      height: 34px;
      border-radius: 6px;
      border: 1px dashed #c7c7cc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      margin-top: 8px;
      transition: border-color 0.15s;
    }

    .btn-add:hover {
      border-color: #3478f6;
    }

    .save-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #15803d;
      color: #fff;
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      transition: transform 0.25s ease;
      z-index: 100;
    }

    .save-toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .btn-save {
      background: #15803d;
      color: white;
    }

    .btn-save:hover {
      background: #166534;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .btn {
      padding: 10px 22px;
      border-radius: 7px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .btn-primary {
      background: #3478f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #f5f5f7;
      color: #636366;
      border: 1px solid #d2d2d7;
    }

    .btn-secondary:hover {
      background: #e8e8ed;
      color: #1d1d1f;
    }

    .error-msg {
      color: #dc2626;
      text-align: center;
      margin-top: 14px;
      font-size: 13px;
    }

    /* Video Preview */
    .video-preview {
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      border: 1px solid #e8e8ed;
    }

    .video-preview video {
      width: 100%;
      max-height: 380px;
      display: block;
    }

    /* Style Settings */
    .style-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .style-field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .style-field label {
      font-size: 11px;
      color: #636366;
      font-weight: 600;
    }

    .style-field select,
    .style-field input[type="number"] {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #1d1d1f;
      padding: 8px 10px;
      font-size: 13px;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
    }

    .style-field select:focus,
    .style-field input[type="number"]:focus {
      outline: none;
      border-color: #3478f6;
      background: #fff;
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-row input[type="color"] {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
    }

    .color-row .color-hex {
      background: #f5f5f7;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      color: #1d1d1f;
      padding: 8px 10px;
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      width: 95px;
    }

    .pos-buttons {
      display: flex;
      gap: 3px;
    }

    .pos-btn {
      flex: 1;
      padding: 8px 0;
      border: 1px solid #d2d2d7;
      border-radius: 5px;
      background: #f5f5f7;
      color: #636366;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.15s;
    }

    .pos-btn.active {
      background: #3478f6;
      color: white;
      border-color: #3478f6;
    }

    .pos-btn:hover:not(.active) {
      border-color: #aeaeb2;
    }

    .style-preview {
      margin-top: 14px;
      background: #1d1d1f;
      border-radius: 8px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .style-preview-text {
      padding: 6px 16px;
      border-radius: 6px;
      text-align: center;
      transition: all 0.15s;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toggle {
      width: 40px;
      height: 22px;
      border-radius: 11px;
      background: #d2d2d7;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }

    .toggle.active {
      background: #3478f6;
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    .toggle.active::after {
      transform: translateX(18px);
    }

    /* â”€â”€ Tab Navigation â”€â”€ */
    .tab-nav {
      display: flex;
      gap: 2px;
      background: #fff;
      border: 1px solid #e8e8ed;
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      border: none;
      border-radius: 7px;
      background: transparent;
      color: #86868b;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: #1d1d1f;
      background: #f5f5f7;
    }

    .tab-btn.active {
      background: #3478f6;
      color: #fff;
      box-shadow: 0 1px 3px rgba(52, 120, 246, 0.3);
    }

    .tab-btn .tab-icon {
      font-size: 14px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Responsive â€” Tablet (â‰¤768px)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 768px) {
      .container {
        padding: 32px 16px 60px;
      }

      h1 {
        font-size: 20px;
      }

      /* Grids â†’ single column */
      .style-grid,
      .filter-grid,
      .kb-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .style-field[style*="grid-column"] {
        grid-column: auto !important;
      }

      /* Subtitle items â€” stack vertically */
      .subtitle-item {
        flex-wrap: wrap;
        gap: 6px;
        padding: 10px 0;
      }

      .subtitle-item input[type="text"] {
        flex-basis: 100%;
        order: 2;
      }

      .subtitle-item .sub-index {
        order: 0;
      }

      /* Edit fields */
      .edit-row {
        gap: 8px;
      }

      /* Actions â€” stack buttons on tablet */
      .actions {
        flex-wrap: wrap;
      }

      .actions .btn {
        flex: 1;
        min-width: 120px;
      }

      /* Utility bar scroll */
      .utility-bar {
        gap: 4px;
        padding: 10px 12px;
      }

      /* Export buttons wider */
      .export-btn {
        padding: 10px 16px;
      }

      /* Speed presets wrap nicely */
      .speed-presets {
        flex-wrap: wrap;
      }

      /* Tab nav â€” smaller on tablet */
      .tab-nav {
        gap: 1px;
        padding: 3px;
      }

      .tab-btn {
        padding: 8px 6px;
        font-size: 11px;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Responsive â€” Phone (â‰¤480px)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 480px) {
      .container {
        padding: 24px 12px 48px;
      }

      h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 12px;
        margin-bottom: 24px;
      }

      /* Upload area smaller */
      .upload-area {
        padding: 36px 16px;
      }

      .upload-icon {
        font-size: 28px;
        margin-bottom: 8px;
      }

      .upload-text {
        font-size: 14px;
      }

      .upload-hint {
        font-size: 11px;
      }

      /* Cards tighter */
      .audio-card,
      .edit-card,
      .visual-card,
      .telop-card,
      .export-card,
      .style-card,
      .result-card {
        padding: 14px;
      }

      /* Subtitle items fully stacked */
      .subtitle-item {
        font-size: 12px;
        padding: 8px 0;
      }

      .subtitle-item input[type="text"] {
        padding: 8px;
        font-size: 14px;
        /* bigger for mobile input */
      }

      .subtitle-item input[type="number"] {
        width: 48px;
        padding: 6px 2px;
        font-size: 12px;
      }

      /* Telop items */
      .telop-top {
        gap: 6px;
      }

      .telop-top input[type="text"] {
        font-size: 14px;
        padding: 8px;
      }

      /* Style fields â€” bigger inputs for touch */
      .style-field select,
      .style-field input[type="number"] {
        padding: 10px;
        font-size: 14px;
      }

      .color-row input[type="color"] {
        width: 40px;
        height: 40px;
      }

      .color-row .color-hex {
        padding: 10px;
        font-size: 14px;
        width: 100px;
      }

      /* Position buttons bigger for touch */
      .pos-btn {
        padding: 10px 0;
        font-size: 13px;
      }

      /* Edit fields â€” slightly bigger */
      .edit-field input[type="number"],
      .edit-field select {
        padding: 8px 6px;
        font-size: 13px;
        width: 60px;
      }

      .edit-field label {
        font-size: 12px;
      }

      /* Toggle bigger for touch */
      .toggle {
        width: 44px;
        height: 24px;
        border-radius: 12px;
      }

      .toggle::after {
        width: 18px;
        height: 18px;
      }

      .toggle.active::after {
        transform: translateX(20px);
      }

      /* Buttons bigger for touch */
      .btn {
        padding: 12px 20px;
        font-size: 14px;
        width: 100%;
      }

      .actions {
        flex-direction: column;
        gap: 8px;
      }

      .export-btn {
        padding: 12px 16px;
        font-size: 13px;
        width: 100%;
      }

      .export-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .export-field {
        width: 100%;
      }

      .export-field select {
        flex: 1;
      }

      /* Add/Upload buttons taller for touch */
      .btn-add,
      .audio-upload-btn,
      .overlay-upload-btn,
      .merge-upload-btn,
      .telop-add-btn {
        height: 40px;
        font-size: 13px;
      }

      /* Delete button bigger for touch */
      .btn-icon {
        width: 32px;
        height: 32px;
        font-size: 15px;
      }

      /* Utility bar â€” scrollable */
      .utility-bar {
        padding: 10px;
        gap: 4px;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .util-btn {
        padding: 8px 10px;
        font-size: 11px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Shortcut panel */
      .shortcut-panel {
        padding: 10px 12px;
        font-size: 11px;
      }

      /* Video preview */
      .video-preview video {
        max-height: 240px;
      }

      /* Filter sliders â€” slightly bigger */
      .filter-item input[type="range"] {
        height: 6px;
      }

      /* Ken Burns fields */
      .kb-field input {
        width: 52px;
        padding: 8px 4px;
        font-size: 13px;
      }

      /* Overlay items stack */
      .overlay-item {
        font-size: 11px;
        gap: 6px;
      }

      /* Speed presets */
      .speed-preset-btn {
        padding: 7px 10px;
        font-size: 12px;
      }

      /* Seg style row */
      .seg-style-row {
        margin-left: 0;
        padding: 8px;
      }

      /* Tab nav â€” compact on phone */
      .tab-nav {
        padding: 3px;
        border-radius: 8px;
      }

      .tab-btn {
        padding: 8px 4px;
        font-size: 10px;
        flex-direction: column;
        gap: 2px;
      }

      .tab-btn .tab-icon {
        font-size: 16px;
      }

      /* Thumb preview full width */
      .thumb-preview {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ¬ å‹•ç”»ç·¨é›†ãƒ„ãƒ¼ãƒ«</h1>
    <p class="subtitle">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨AIãŒè‡ªå‹•ã§å­—å¹•ã‚’ã¤ã‘ã¾ã™ã€ãã®ä»–ç°¡å˜ãªç·¨é›†ã‚‚å¯èƒ½ã§ã™ã€‚</p>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">å‹•ç”»ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
      <div class="upload-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆ.mp4, .mov, .webmï¼‰</div>
      <input type="file" id="fileInput" accept="video/*">
    </div>

    <!-- Video Preview -->
    <div class="video-preview" id="videoPreview" style="display:none">
      <video id="previewVideo" controls></video>
    </div>

    <!-- Progress -->
    <div class="progress-section" id="progressSection">
      <div class="step" id="stepUpload">
        <div class="step-icon">â¬†ï¸</div>
        <div class="step-text">
          <div class="step-title">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
          <div class="step-detail" id="uploadDetail"></div>
        </div>
      </div>
      <div class="step" id="stepExtract">
        <div class="step-icon">ğŸµ</div>
        <div class="step-text">
          <div class="step-title">éŸ³å£°ã‚’æŠ½å‡ºä¸­...</div>
          <div class="step-detail">FFmpegã§å‹•ç”»ã‹ã‚‰éŸ³å£°ã‚’åˆ†é›¢ã—ã¾ã™</div>
        </div>
      </div>
      <div class="step" id="stepTranscribe">
        <div class="step-icon">ğŸ¤–</div>
        <div class="step-text">
          <div class="step-title">AIã§æ–‡å­—èµ·ã“ã—ä¸­...</div>
          <div class="step-detail">ãƒ­ãƒ¼ã‚«ãƒ«Whisperã§éŸ³å£°èªè­˜ã—ã¾ã™ï¼ˆåˆå›ã¯ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰</div>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div class="result-section" id="resultSection">

      <!-- Tab Navigation -->
      <div class="tab-nav" id="tabNav">
        <button class="tab-btn active" onclick="switchTab('subtitle')" data-tab="subtitle">
          <span class="tab-icon">ğŸ“</span> å­—å¹•
        </button>
        <button class="tab-btn" onclick="switchTab('edit')" data-tab="edit">
          <span class="tab-icon">ğŸ¬</span> ç·¨é›†
        </button>
        <button class="tab-btn" onclick="switchTab('effects')" data-tab="effects">
          <span class="tab-icon">âœ¨</span> ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        </button>
        <button class="tab-btn" onclick="switchTab('export')" data-tab="export">
          <span class="tab-icon">ğŸ“¤</span> å‡ºåŠ›
        </button>
      </div>

      <!-- â”€â”€ Tab: å­—å¹• â”€â”€ -->
      <div class="tab-panel active" id="tabSubtitle">
        <div class="result-card">
          <div class="result-title">ğŸ“ å­—å¹•ç·¨é›†</div>
          <div class="subtitle-list" id="subtitleList"></div>
          <button class="btn-add" onclick="addSubtitle()">ï¼‹ å­—å¹•ã‚’è¿½åŠ </button>
        </div>

        <!-- Style Settings -->
        <div class="style-card">
          <div class="style-title">ğŸ¨ ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š</div>
          <div class="style-grid">
            <div class="style-field" style="grid-column: 1 / -1">
              <label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
              <select id="styleFont" onchange="updateStyle()">
                <optgroup label="â€” ã‚´ã‚·ãƒƒã‚¯ä½“ â€”">
                  <option value="Noto Sans JP">Noto Sans JP</option>
                  <option value="M PLUS 1p">M PLUS 1p</option>
                  <option value="Zen Kaku Gothic New">Zenè§’ã‚´ã‚·ãƒƒã‚¯</option>
                  <option value="Sawarabi Gothic">ã•ã‚ã‚‰ã³ã‚´ã‚·ãƒƒã‚¯</option>
                  <option value="DotGothic16">ãƒ‰ãƒƒãƒˆã‚´ã‚·ãƒƒã‚¯16</option>
                </optgroup>
                <optgroup label="â€” ä¸¸ã‚´ã‚·ãƒƒã‚¯ä½“ â€”">
                  <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
                  <option value="Kosugi Maru">å°æ‰ä¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                  <option value="Zen Maru Gothic">Zenä¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                  <option value="Kiwi Maru">ã‚­ã‚¦ã‚¤ä¸¸</option>
                </optgroup>
                <optgroup label="â€” æ˜æœä½“ â€”">
                  <option value="Noto Serif JP">Noto Serif JP</option>
                  <option value="Shippori Mincho">ã—ã£ã½ã‚Šæ˜æœ</option>
                  <option value="Zen Old Mincho">Zenã‚ªãƒ¼ãƒ«ãƒ‰æ˜æœ</option>
                  <option value="Sawarabi Mincho">ã•ã‚ã‚‰ã³æ˜æœ</option>
                </optgroup>
                <optgroup label="â€” ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»è£…é£¾ â€”">
                  <option value="Dela Gothic One">ãƒ‡ãƒ©ã‚´ã‚·ãƒƒã‚¯</option>
                  <option value="Reggae One">ãƒ¬ã‚²ã‚¨</option>
                  <option value="RocknRoll One">ãƒ­ãƒƒã‚¯ãƒ³ãƒ­ãƒ¼ãƒ«</option>
                  <option value="Stick">ã‚¹ãƒ†ã‚£ãƒƒã‚¯</option>
                  <option value="Potta One">ãƒãƒƒã‚¿</option>
                  <option value="Rampart One">ãƒ©ãƒ³ãƒ‘ãƒ¼ãƒˆ</option>
                  <option value="Train One">ãƒˆãƒ¬ã‚¤ãƒ³</option>
                </optgroup>
                <optgroup label="â€” æ‰‹æ›¸ããƒ»ãƒãƒƒãƒ— â€”">
                  <option value="Hachi Maru Pop">ã¯ã¡ã¾ã‚‹ãƒãƒƒãƒ—</option>
                  <option value="Yusei Magic">ãƒ¦ã‚¦ã‚»ã‚¤ãƒã‚¸ãƒƒã‚¯</option>
                </optgroup>
                <optgroup label="â€” æ¬§æ–‡ãƒ•ã‚©ãƒ³ãƒˆ â€”">
                  <option value="Arial">Arial</option>
                  <option value="Helvetica">Helvetica</option>
                  <option value="Roboto">Roboto</option>
                  <option value="Open Sans">Open Sans</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Lato">Lato</option>
                  <option value="Inter">Inter</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Courier New">Courier New</option>
                  <option value="Verdana">Verdana</option>
                  <option value="Impact">Impact</option>
                  <option value="Comic Sans MS">Comic Sans MS</option>
                </optgroup>
              </select>
            </div>
            <div class="style-field">
              <label>ã‚µã‚¤ã‚º (px)</label>
              <input type="number" id="styleFontSize" value="42" min="16" max="120" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>å¤ªå­—</label>
              <div class="toggle-row">
                <button class="toggle active" id="styleBold"
                  onclick="this.classList.toggle('active'); updateStyle()"></button>
                <span style="font-size:13px; color:#888" id="boldLabel">ON</span>
              </div>
            </div>
            <div class="style-field">
              <label>ç¸å–ã‚Šå¹… (px)</label>
              <input type="number" id="styleOutlineWidth" value="0" min="0" max="10" step="1" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>ç¸å–ã‚Šè‰²</label>
              <div class="color-row">
                <input type="color" id="styleOutlineColor" value="#000000" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleOutlineColorHex" value="#000000"
                  onchange="document.getElementById('styleOutlineColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>æ–‡å­—ã®è‰²</label>
              <div class="color-row">
                <input type="color" id="styleFontColor" value="#ffffff" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleFontColorHex" value="#ffffff"
                  onchange="document.getElementById('styleFontColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>èƒŒæ™¯ã®è‰²</label>
              <div class="color-row">
                <input type="color" id="styleBgColor" value="#000000" onchange="updateStyle()">
                <input type="text" class="color-hex" id="styleBgColorHex" value="#000000"
                  onchange="document.getElementById('styleBgColor').value=this.value; updateStyle()">
              </div>
            </div>
            <div class="style-field">
              <label>èƒŒæ™¯ã®é€æ˜åº¦ (%)</label>
              <input type="number" id="styleBgOpacity" value="75" min="0" max="100" step="5" onchange="updateStyle()">
            </div>
            <div class="style-field">
              <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®</label>
              <div class="pos-buttons">
                <button class="pos-btn" onclick="setPosition('top')">ä¸Š</button>
                <button class="pos-btn" onclick="setPosition('center')">ä¸­å¤®</button>
                <button class="pos-btn active" onclick="setPosition('bottom')">ä¸‹</button>
                <button class="pos-btn" onclick="setPosition('custom')">XYæŒ‡å®š</button>
              </div>
            </div>
            <div class="style-field" id="customPosField" style="display:none">
              <label>ã‚«ã‚¹ã‚¿ãƒ ä½ç½® (X%, Y%)</label>
              <div class="color-row">
                <span style="color:#888; font-size:12px">X</span>
                <input type="number" id="stylePosX" value="50" min="0" max="100" style="width:60px"
                  onchange="updateStyle()">
                <span style="color:#888; font-size:12px">Y</span>
                <input type="number" id="stylePosY" value="90" min="0" max="100" style="width:60px"
                  onchange="updateStyle()">
              </div>
            </div>
          </div>
          <div class="style-preview" id="stylePreview">
            <div class="style-preview-text" id="stylePreviewText">ã‚µãƒ³ãƒ—ãƒ«å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆ</div>
          </div>
        </div>

        <!-- Animation -->
        <div class="style-card">
          <div class="style-title">âœ¨ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
          <div class="style-grid">
            <div class="style-field" style="grid-column: 1 / -1">
              <label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</label>
              <select id="styleAnimation" onchange="updateStyle()">
                <option value="fadeIn">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</option>
                <option value="slideUp">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ— â†‘</option>
                <option value="slideDown">ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³ â†“</option>
                <option value="pop">ãƒãƒƒãƒ—</option>
                <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
                <option value="typewriter">ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼</option>
                <option value="none">ãªã—</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Tab: ç·¨é›† â”€â”€ -->
      <div class="tab-panel" id="tabEdit">
        <!-- Audio Tracks -->
        <div class="audio-card">
          <div class="audio-title">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰</div>
          <div id="audioTrackList"></div>
          <button class="audio-upload-btn" onclick="document.getElementById('audioFileInput').click()">ï¼‹
            éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </button>
          <input type="file" id="audioFileInput" accept="audio/*" style="display:none" onchange="uploadAudioFile(this)">
        </div>

        <!-- Video Editing -->
        <div class="edit-card">
          <div class="edit-title">ğŸ¬ å‹•ç”»ç·¨é›†</div>

          <!-- Trim -->
          <div class="edit-section">
            <div class="edit-section-title">âœ‚ï¸ ãƒˆãƒªãƒŸãƒ³ã‚°</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>é–‹å§‹</label>
                <input type="number" id="trimStart" value="0" min="0" step="0.1" onchange="updateEditSettings()">
                <label>ç§’</label>
              </div>
              <span style="color:#555">â†’</span>
              <div class="edit-field">
                <label>çµ‚äº†</label>
                <input type="number" id="trimEnd" value="" min="0" step="0.1" placeholder="æœ€å¾Œ"
                  onchange="updateEditSettings()">
                <label>ç§’</label>
              </div>
            </div>
            <div class="edit-hint">â€» çµ‚äº†ãŒç©ºæ¬„ã®å ´åˆã¯å‹•ç”»ã®æœ€å¾Œã¾ã§</div>
          </div>

          <!-- Transition -->
          <div class="edit-section">
            <div class="edit-section-title">âœ¨ ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</label>
                <input type="number" id="fadeIn" value="0" min="0" max="5" step="0.1" onchange="updateEditSettings()">
                <label>ç§’</label>
              </div>
              <div class="edit-field">
                <label>ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ</label>
                <input type="number" id="fadeOut" value="0" min="0" max="5" step="0.1" onchange="updateEditSettings()">
                <label>ç§’</label>
              </div>
            </div>
          </div>

          <!-- Speed -->
          <div class="edit-section">
            <div class="edit-section-title">â© å†ç”Ÿé€Ÿåº¦</div>
            <div class="edit-row">
              <div class="edit-field">
                <label>å€é€Ÿ</label>
                <input type="number" id="playbackSpeed" value="1" min="0.1" max="4" step="0.1"
                  onchange="updateEditSettings(); updateSpeedPresets()">
                <label>x</label>
              </div>
            </div>
            <div class="speed-presets">
              <button class="speed-preset-btn" onclick="setSpeed(0.25)">0.25x</button>
              <button class="speed-preset-btn" onclick="setSpeed(0.5)">0.5x</button>
              <button class="speed-preset-btn active" onclick="setSpeed(1)">1x</button>
              <button class="speed-preset-btn" onclick="setSpeed(1.5)">1.5x</button>
              <button class="speed-preset-btn" onclick="setSpeed(2)">2x</button>
              <button class="speed-preset-btn" onclick="setSpeed(4)">4x</button>
            </div>
            <div class="edit-hint">â€» 0.5x = ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã€ 2x = æ—©é€ã‚Š</div>
          </div>

          <!-- Merge -->
          <div class="edit-section">
            <div class="edit-section-title">ğŸ”— å‹•ç”»ã®çµåˆ</div>
            <div id="mergeVideoList"></div>
            <button class="merge-upload-btn" onclick="document.getElementById('mergeVideoInput').click()">ï¼‹
              å‹•ç”»ã‚’è¿½åŠ ã—ã¦çµåˆ</button>
            <input type="file" id="mergeVideoInput" accept="video/*" style="display:none"
              onchange="uploadMergeVideo(this)">
            <div class="edit-hint">â€» ãƒ¡ã‚¤ãƒ³å‹•ç”»ã®å¾Œã‚ã«çµåˆã•ã‚Œã¾ã™</div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Tab: ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ â”€â”€ -->
      <div class="tab-panel" id="tabEffects">
        <!-- Image Overlays -->
        <div class="visual-card">
          <div class="visual-title overlay">ğŸ–¼ï¸ ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</div>
          <div id="overlayList"></div>
          <button class="overlay-upload-btn" onclick="document.getElementById('overlayImageInput').click()">ï¼‹
            ç”»åƒã‚’è¿½åŠ </button>
          <input type="file" id="overlayImageInput" accept="image/*" style="display:none"
            onchange="uploadOverlayImage(this)">
          <div class="edit-hint">â€» ãƒ­ã‚´ã€ã‚¹ã‚¿ãƒ³ãƒ—ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãªã©ã‚’å¥½ããªä½ç½®ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡¨ç¤º</div>
        </div>

        <!-- Filters -->
        <div class="visual-card">
          <div class="visual-title filter">ğŸ¨ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ / è‰²èª¿è£œæ­£</div>
          <div class="filter-grid">
            <div class="filter-item">
              <label>æ˜ã‚‹ã• <span id="filterBrightnessVal">100%</span></label>
              <input type="range" id="filterBrightness" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ <span id="filterContrastVal">100%</span></label>
              <input type="range" id="filterContrast" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>å½©åº¦ <span id="filterSaturateVal">100%</span></label>
              <input type="range" id="filterSaturate" min="0" max="200" value="100" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>ã‚»ãƒ”ã‚¢ <span id="filterSepiaVal">0%</span></label>
              <input type="range" id="filterSepia" min="0" max="100" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>ãƒ¢ãƒã‚¯ãƒ­ <span id="filterGrayscaleVal">0%</span></label>
              <input type="range" id="filterGrayscale" min="0" max="100" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>è‰²ç›¸å›è»¢ <span id="filterHueVal">0Â°</span></label>
              <input type="range" id="filterHue" min="0" max="360" value="0" oninput="updateFilters()">
            </div>
            <div class="filter-item">
              <label>ã¼ã‹ã— <span id="filterBlurVal">0px</span></label>
              <input type="range" id="filterBlur" min="0" max="20" value="0" step="0.5" oninput="updateFilters()">
            </div>
            <div class="filter-item" style="display:flex; align-items:flex-end; justify-content:flex-end">
              <button class="btn-reset" onclick="resetFilters()">â†º ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>
        </div>

        <!-- Ken Burns -->
        <div class="visual-card">
          <div class="visual-title kenburns">ğŸ“· ã‚ºãƒ¼ãƒ  / ãƒ‘ãƒ³ï¼ˆKen Burnsï¼‰</div>
          <div style="margin-bottom:12px">
            <div class="toggle-row">
              <button class="toggle" id="kbToggle" onclick="this.classList.toggle('active'); updateKenBurns()"></button>
              <span style="font-size:13px; color:#888" id="kbLabel">OFF</span>
            </div>
          </div>
          <div id="kbControls" style="display:none">
            <div class="edit-hint" style="margin-bottom:8px">â€» é–‹å§‹â†’çµ‚äº†ã«ã‹ã‘ã¦å€¤ãŒå¤‰åŒ–ã—ã¾ã™</div>
            <div class="kb-grid">
              <div>
                <div style="font-size:12px; color:#888; margin-bottom:6px">é–‹å§‹</div>
                <div class="kb-field">
                  <label>ã‚ºãƒ¼ãƒ </label>
                  <input type="number" id="kbStartScale" value="1.0" min="0.5" max="3" step="0.05"
                    onchange="updateKenBurns()">
                </div>
                <div class="kb-field" style="margin-top:6px">
                  <label>X</label>
                  <input type="number" id="kbStartX" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                  <label>Y</label>
                  <input type="number" id="kbStartY" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                </div>
              </div>
              <div>
                <div style="font-size:12px; color:#888; margin-bottom:6px">çµ‚äº†</div>
                <div class="kb-field">
                  <label>ã‚ºãƒ¼ãƒ </label>
                  <input type="number" id="kbEndScale" value="1.2" min="0.5" max="3" step="0.05"
                    onchange="updateKenBurns()">
                </div>
                <div class="kb-field" style="margin-top:6px">
                  <label>X</label>
                  <input type="number" id="kbEndX" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                  <label>Y</label>
                  <input type="number" id="kbEndY" value="0" min="-50" max="50" step="1" onchange="updateKenBurns()">
                </div>
              </div>
            </div>
            <div class="speed-presets" style="margin-top:10px">
              <button class="speed-preset-btn" onclick="setKBPreset(1.0,1.2,0,0,0,0)">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.2,1.0,0,0,0,0)">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.1,1.1,-10,10,0,0)">å·¦â†’å³ãƒ‘ãƒ³</button>
              <button class="speed-preset-btn" onclick="setKBPreset(1.15,1.15,0,0,5,-5)">ä¸‹â†’ä¸Šãƒ‘ãƒ³</button>
            </div>
          </div>
        </div>

        <!-- Free Telop -->
        <div class="telop-card">
          <div class="telop-title">ğŸ“ ãƒ•ãƒªãƒ¼ãƒ†ãƒ­ãƒƒãƒ—</div>
          <div id="telopList"></div>
          <button class="telop-add-btn" onclick="addTelop()">ï¼‹ ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¿½åŠ </button>
          <div class="edit-hint">â€» å­—å¹•ã¨ã¯åˆ¥ã«è‡ªç”±ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å¥½ããªä½ç½®ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è¡¨ç¤º</div>
        </div>
      </div>

      <!-- â”€â”€ Tab: å‡ºåŠ› â”€â”€ -->
      <div class="tab-panel" id="tabExport">
        <!-- Export Section -->
        <div class="export-card">
          <div class="export-title">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>

          <!-- MP4 Render -->
          <div class="export-section">
            <div class="export-section-title">ğŸ¬ MP4ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°</div>
            <div class="export-row">
              <button class="export-btn render" id="renderBtn" onclick="startRender()">ğŸ“¦ å‹•ç”»ã‚’æ›¸ãå‡ºã—</button>
            </div>
            <div class="edit-hint">â€» ç¾åœ¨ã®è¨­å®šã‚’å…¨ã¦åæ˜ ã—ã¦MP4ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</div>
            <div class="render-status" id="renderStatus"></div>
            <div id="renderResult"></div>
          </div>

          <!-- SRT/VTT -->
          <div class="export-section">
            <div class="export-section-title">ğŸ“ å­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
            <div class="export-row">
              <div class="export-field">
                <label>å½¢å¼</label>
                <select id="exportSubFormat">
                  <option value="srt">SRTï¼ˆYouTubeå¯¾å¿œï¼‰</option>
                  <option value="vtt">WebVTT</option>
                </select>
              </div>
              <button class="export-btn sub" onclick="exportSubtitles()">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div class="edit-hint">â€» YouTubeã‚„å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ã®å­—å¹•ãƒ•ã‚¡ã‚¤ãƒ«</div>
          </div>

          <!-- Thumbnail -->
          <div class="export-section">
            <div class="export-section-title">ğŸ–¼ï¸ ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ</div>
            <div class="export-row">
              <div class="export-field">
                <label>æ™‚åˆ»</label>
                <input type="number" id="thumbTime" value="0" min="0" step="0.1">
                <label>ç§’</label>
              </div>
              <button class="export-btn thumb" onclick="generateThumbnail()">ğŸ“¸ ç”Ÿæˆ</button>
            </div>
            <div class="edit-hint">â€» æŒ‡å®šã—ãŸæ™‚åˆ»ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’JPEGã§ä¿å­˜</div>
            <div id="thumbResult"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-save" onclick="saveAll()">ğŸ’¾ ä¿å­˜</button>
          <button class="btn btn-primary" onclick="saveAndOpenStudio()">Remotion Studioã§ç¢ºèª â†’</button>
          <button class="btn btn-secondary" onclick="location.reload()">åˆ¥ã®å‹•ç”»ã‚’å‡¦ç†</button>
        </div>

        <!-- Utility Bar -->
        <div class="utility-bar" id="utilityBar">
          <span class="utility-title">ğŸ› </span>
          <button class="util-btn undo" id="undoBtn" onclick="undo()" disabled title="Ctrl+Z">â†© æˆ»ã™</button>
          <button class="util-btn redo" id="redoBtn" onclick="redo()" disabled title="Ctrl+Shift+Z">â†ª ã‚„ã‚Šç›´ã—</button>
          <span class="undo-count" id="undoCount"></span>
          <div class="util-sep"></div>
          <button class="util-btn project-save" onclick="downloadProject()" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜">ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜</button>
          <button class="util-btn project-load" onclick="document.getElementById('projectFileInput').click()"
            title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­è¾¼">ğŸ“‚ èª­è¾¼</button>
          <input type="file" id="projectFileInput" accept=".json" style="display:none" onchange="loadProject(this)">
          <div class="util-sep"></div>
          <button class="util-btn shortcut-help"
            onclick="document.getElementById('shortcutPanel').classList.toggle('open')" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§">âŒ¨
            ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</button>
        </div>
        <div class="shortcut-panel" id="shortcutPanel">
          <table>
            <tr>
              <td>Ctrl + S</td>
              <td>ä¿å­˜ï¼ˆå…¨è¨­å®šã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼‰</td>
            </tr>
            <tr>
              <td>Ctrl + Z</td>
              <td>å…ƒã«æˆ»ã™</td>
            </tr>
            <tr>
              <td>Ctrl + Shift + Z</td>
              <td>ã‚„ã‚Šç›´ã—</td>
            </tr>
            <tr>
              <td>Ctrl + E</td>
              <td>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’JSONã§ä¿å­˜</td>
            </tr>
            <tr>
              <td>Ctrl + O</td>
              <td>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿</td>
            </tr>
            <tr>
              <td>Ctrl + Enter</td>
              <td>Remotion Studioã‚’é–‹ã</td>
            </tr>
          </table>
        </div>
      </div><!-- /tabExport -->
    </div><!-- /resultSection -->
    <div class="save-toast" id="saveToast">âœ… ä¿å­˜ã—ã¾ã—ãŸ</div>

    <div class="error-msg" id="errorMsg"></div>
  </div>

  <script>
    // Tab Navigation
    function switchTab(tabName) {
      const panelMap = {
        subtitle: 'tabSubtitle',
        edit: 'tabEdit',
        effects: 'tabEffects',
        export: 'tabExport'
      };
      // Deactivate all
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      // Activate clicked
      document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(panelMap[tabName]).classList.add('active');
    }

    const SERVER = window.location.origin;
    let currentFilename = "";
    let currentSubtitles = [];
    let currentStyle = {
      fontFamily: "Noto Sans JP",
      fontSize: 42,
      fontColor: "#ffffff",
      bgColor: "#000000",
      bgOpacity: 0.75,
      position: "bottom",
      posX: 50,
      posY: 90,
      bold: true,
      animation: "fadeIn",
      outlineWidth: 0,
      outlineColor: "#000000"
    };
    let audioTracks = [];
    let editSettings = {
      trim: { startTime: 0, endTime: null },
      transition: { fadeIn: 0, fadeOut: 0 },
      speedSections: [{ start: 0, end: 9999, speed: 1 }],
      additionalVideos: [],
      imageOverlays: [],
      filters: { brightness: 100, contrast: 100, saturate: 100, sepia: 0, grayscale: 0, hueRotate: 0, blur: 0 },
      kenBurns: { enabled: false, startScale: 1.0, endScale: 1.2, startX: 0, endX: 0, startY: 0, endY: 0 },
      textOverlays: []
    };

    // Undo/Redo
    let undoStack = [];
    let redoStack = [];
    const MAX_UNDO = 50;

    function takeSnapshot() {
      const snap = JSON.stringify({ currentSubtitles, currentStyle, audioTracks, editSettings });
      if (undoStack.length > 0 && undoStack[undoStack.length - 1] === snap) return;
      undoStack.push(snap);
      if (undoStack.length > MAX_UNDO) undoStack.shift();
      redoStack = [];
      updateUndoButtons();
    }

    function undo() {
      if (undoStack.length < 2) return;
      redoStack.push(undoStack.pop());
      const snap = JSON.parse(undoStack[undoStack.length - 1]);
      currentSubtitles = snap.currentSubtitles;
      currentStyle = snap.currentStyle;
      audioTracks = snap.audioTracks;
      editSettings = snap.editSettings;
      refreshUI();
      updateUndoButtons();
    }

    function redo() {
      if (redoStack.length === 0) return;
      const snap = JSON.parse(redoStack.pop());
      undoStack.push(JSON.stringify(snap));
      currentSubtitles = snap.currentSubtitles;
      currentStyle = snap.currentStyle;
      audioTracks = snap.audioTracks;
      editSettings = snap.editSettings;
      refreshUI();
      updateUndoButtons();
    }

    function updateUndoButtons() {
      document.getElementById('undoBtn').disabled = undoStack.length < 2;
      document.getElementById('redoBtn').disabled = redoStack.length === 0;
      const count = document.getElementById('undoCount');
      count.textContent = `${undoStack.length - 1}/${MAX_UNDO}`;
    }

    function refreshUI() {
      displayResults();
      displayAudioTracks();
      displayOverlays();
      displayMergeVideos();
      displayTelops();
    }

    // Drag & Drop
    const uploadArea = document.getElementById("uploadArea");
    const fileInput = document.getElementById("fileInput");

    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("dragover");
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("dragover");
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith("video/")) {
        processFile(file);
      }
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });

    function setStep(id, state) {
      const el = document.getElementById(id);
      el.className = `step ${state}`;
      if (state === "active") {
        const icon = el.querySelector(".step-icon");
        icon.innerHTML = '<div class="spinner"></div>';
      } else if (state === "done") {
        const icon = el.querySelector(".step-icon");
        icon.textContent = "âœ…";
      } else if (state === "error") {
        const icon = el.querySelector(".step-icon");
        icon.textContent = "âŒ";
      }
    }

    function updateStyle() {
      currentStyle.fontFamily = document.getElementById('styleFont').value;
      currentStyle.fontSize = parseInt(document.getElementById('styleFontSize').value);
      currentStyle.fontColor = document.getElementById('styleFontColor').value;
      currentStyle.bgColor = document.getElementById('styleBgColor').value;
      currentStyle.bgOpacity = parseInt(document.getElementById('styleBgOpacity').value) / 100;
      currentStyle.bold = document.getElementById('styleBold').classList.contains('active');
      currentStyle.posX = parseInt(document.getElementById('stylePosX').value) || 50;
      currentStyle.posY = parseInt(document.getElementById('stylePosY').value) || 90;
      document.getElementById('styleFontColorHex').value = currentStyle.fontColor;
      document.getElementById('styleBgColorHex').value = currentStyle.bgColor;
      document.getElementById('boldLabel').textContent = currentStyle.bold ? 'ON' : 'OFF';
      currentStyle.animation = document.getElementById('styleAnimation').value;
      currentStyle.outlineWidth = parseInt(document.getElementById('styleOutlineWidth').value) || 0;
      currentStyle.outlineColor = document.getElementById('styleOutlineColor').value;
      document.getElementById('styleOutlineColorHex').value = currentStyle.outlineColor;
      document.getElementById('customPosField').style.display = currentStyle.position === 'custom' ? '' : 'none';
      updatePreview();
    }

    function setPosition(pos) {
      currentStyle.position = pos;
      document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('customPosField').style.display = pos === 'custom' ? '' : 'none';
      updatePreview();
    }

    function updatePreview() {
      const preview = document.getElementById('stylePreview');
      const text = document.getElementById('stylePreviewText');
      const r = parseInt(currentStyle.bgColor.slice(1, 3), 16);
      const g = parseInt(currentStyle.bgColor.slice(3, 5), 16);
      const b = parseInt(currentStyle.bgColor.slice(5, 7), 16);
      text.style.backgroundColor = `rgba(${r},${g},${b},${currentStyle.bgOpacity})`;
      text.style.color = currentStyle.fontColor;
      text.style.fontSize = Math.min(currentStyle.fontSize, 32) + 'px';
      text.style.fontWeight = currentStyle.bold ? 'bold' : 'normal';
      text.style.fontFamily = `'${currentStyle.fontFamily}', sans-serif`;
      if (currentStyle.outlineWidth > 0) {
        text.style.webkitTextStroke = `${currentStyle.outlineWidth}px ${currentStyle.outlineColor}`;
        text.style.paintOrder = 'stroke fill';
      } else {
        text.style.webkitTextStroke = '';
      }
      if (currentStyle.position === 'custom') {
        preview.style.alignItems = 'center';
        text.style.position = 'absolute';
        text.style.left = currentStyle.posX + '%';
        text.style.top = currentStyle.posY + '%';
        text.style.transform = 'translate(-50%, -50%)';
      } else {
        text.style.position = 'static';
        text.style.transform = 'none';
        preview.style.alignItems = currentStyle.position === 'top' ? 'flex-start' : currentStyle.position === 'center' ? 'center' : 'flex-end';
      }
      text.style.margin = '8px';
    }

    async function processFile(file) {
      const videoPreview = document.getElementById("videoPreview");
      const previewVideo = document.getElementById("previewVideo");
      previewVideo.src = URL.createObjectURL(file);
      videoPreview.style.display = "block";

      document.getElementById("progressSection").classList.add("active");
      document.getElementById("resultSection").classList.remove("active");
      document.getElementById("errorMsg").textContent = "";
      document.getElementById("uploadDetail").textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;

      try {
        setStep("stepUpload", "active");
        const formData = new FormData();
        formData.append("video", file);
        const uploadRes = await fetch(`${SERVER}/api/upload`, {
          method: "POST",
          body: formData,
        });
        if (!uploadRes.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
        const uploadData = await uploadRes.json();
        currentFilename = uploadData.filename;
        setStep("stepUpload", "done");

        setStep("stepExtract", "active");
        setStep("stepTranscribe", "active");
        const transcribeRes = await fetch(`${SERVER}/api/transcribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: currentFilename }),
        });
        setStep("stepExtract", "done");

        if (!transcribeRes.ok) {
          const err = await transcribeRes.json();
          throw new Error(err.error || "æ–‡å­—èµ·ã“ã—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }

        const data = await transcribeRes.json();
        setStep("stepTranscribe", "done");
        currentSubtitles = data.subtitles;
        displayResults();

      } catch (error) {
        document.getElementById("errorMsg").textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        ["stepUpload", "stepExtract", "stepTranscribe"].forEach((id) => {
          const el = document.getElementById(id);
          if (el.classList.contains("active")) setStep(id, "error");
        });
      }
    }

    function displayResults() {
      const list = document.getElementById("subtitleList");
      const fontOptions = Array.from(document.getElementById('styleFont').options)
        .map(o => `<option value="${o.value}">${o.text}</option>`).join('');

      list.innerHTML = currentSubtitles
        .map(
          (sub, i) => `
          <div class="subtitle-item" data-index="${i}">
            <span class="sub-index">${i + 1}</span>
            <input type="number" step="0.1" min="0" value="${sub.start}" onchange="updateSubtitle(${i}, 'start', this.value)" title="é–‹å§‹(ç§’)">
            <span class="time-sep">â†’</span>
            <input type="number" step="0.1" min="0" value="${sub.end}" onchange="updateSubtitle(${i}, 'end', this.value)" title="çµ‚äº†(ç§’)">
            <input type="text" value="${sub.text.replace(/"/g, '&quot;')}" onchange="updateSubtitle(${i}, 'text', this.value)" placeholder="å­—å¹•ãƒ†ã‚­ã‚¹ãƒˆ">
            <div class="seg-pos">
              <span class="seg-pos-label">X</span>
              <input type="number" min="0" max="100" value="${sub.posX ?? ''}" onchange="updateSubtitle(${i}, 'posX', this.value)" placeholder="-">
              <span class="seg-pos-label">Y</span>
              <input type="number" min="0" max="100" value="${sub.posY ?? ''}" onchange="updateSubtitle(${i}, 'posY', this.value)" placeholder="-">
            </div>
            <button class="btn-icon btn-style-toggle" onclick="toggleSegStyle(${i})" title="å€‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ«">ğŸ¨</button>
            <button class="btn-icon btn-delete" onclick="deleteSubtitle(${i})" title="å‰Šé™¤">âœ•</button>
          </div>
          <div class="seg-style-row" id="segStyle${i}">
            <div class="seg-field">
              <label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
              <select onchange="updateSubtitle(${i}, 'fontFamily', this.value)">
                <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                ${fontOptions}
              </select>
            </div>
            <div class="seg-field">
              <label>ã‚µã‚¤ã‚º</label>
              <input type="number" min="16" max="120" value="${sub.fontSize ?? ''}" onchange="updateSubtitle(${i}, 'fontSize', this.value)" placeholder="-">
            </div>
            <div class="seg-field">
              <label>æ–‡å­—è‰²</label>
              <input type="color" value="${sub.fontColor || '#ffffff'}" onchange="updateSubtitle(${i}, 'fontColor', this.value)">
            </div>
            <div class="seg-field">
              <label>èƒŒæ™¯è‰²</label>
              <input type="color" value="${sub.bgColor || '#000000'}" onchange="updateSubtitle(${i}, 'bgColor', this.value)">
            </div>
            <div class="seg-field">
              <label>ã‚¢ãƒ‹ãƒ¡</label>
              <select onchange="updateSubtitle(${i}, 'animation', this.value)">
                <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                <option value="fadeIn">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</option>
                <option value="slideUp">ã‚¹ãƒ©ã‚¤ãƒ‰â†‘</option>
                <option value="slideDown">ã‚¹ãƒ©ã‚¤ãƒ‰â†“</option>
                <option value="pop">ãƒãƒƒãƒ—</option>
                <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
                <option value="typewriter">ã‚¿ã‚¤ãƒ—</option>
                <option value="none">ãªã—</option>
              </select>
            </div>
          </div>
        `
        )
        .join("");

      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå€‹åˆ¥ãƒ•ã‚©ãƒ³ãƒˆãƒ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é¸æŠå€¤ã‚’å¾©å…ƒ
      currentSubtitles.forEach((sub, i) => {
        const row = document.getElementById(`segStyle${i}`);
        if (sub.fontFamily) {
          const sel = row.querySelector('select');
          if (sel) sel.value = sub.fontFamily;
        }
        if (sub.animation) {
          const animSel = row.querySelectorAll('select')[1];
          if (animSel) animSel.value = sub.animation;
        }
      });

      document.getElementById("resultSection").classList.add("active");
    }

    function toggleSegStyle(index) {
      const row = document.getElementById(`segStyle${index}`);
      row.classList.toggle('open');
    }

    function updateSubtitle(index, field, value) {
      if (field === 'start' || field === 'end') {
        currentSubtitles[index][field] = parseFloat(value);
      } else if (field === 'posX' || field === 'posY' || field === 'fontSize') {
        if (value === '' || value === undefined) {
          delete currentSubtitles[index][field];
        } else {
          currentSubtitles[index][field] = parseInt(value);
        }
      } else if (field === 'fontFamily' || field === 'fontColor' || field === 'bgColor' || field === 'animation') {
        if (!value || value === '') {
          delete currentSubtitles[index][field];
        } else {
          currentSubtitles[index][field] = value;
        }
      } else {
        currentSubtitles[index][field] = value;
      }
    }

    function deleteSubtitle(index) {
      currentSubtitles.splice(index, 1);
      displayResults();
    }

    function addSubtitle() {
      const lastEnd = currentSubtitles.length > 0
        ? currentSubtitles[currentSubtitles.length - 1].end
        : 0;
      currentSubtitles.push({
        start: lastEnd,
        end: lastEnd + 3,
        text: ""
      });
      displayResults();
      // æ–°ã—ã„è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        const inputs = document.querySelectorAll('.subtitle-item:last-child input[type="text"]');
        if (inputs.length) inputs[0].focus();
      }, 50);
    }

    async function saveSubtitles() {
      const res = await fetch(`${SERVER}/api/save-subtitles`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, subtitles: currentSubtitles }),
      });
      if (!res.ok) throw new Error("å­—å¹•ã®ä¿å­˜ã«å¤±æ•—");
    }

    async function saveStyle() {
      const res = await fetch(`${SERVER}/api/save-style`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, style: currentStyle }),
      });
      if (!res.ok) throw new Error("ã‚¹ã‚¿ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—");
    }

    async function saveAudioTracks() {
      if (audioTracks.length === 0) return;
      const res = await fetch(`${SERVER}/api/save-audio`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, audioTracks }),
      });
      if (!res.ok) throw new Error("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ä¿å­˜ã«å¤±æ•—");
    }

    async function saveEditSettings() {
      const res = await fetch(`${SERVER}/api/save-edit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, editSettings }),
      });
      if (!res.ok) throw new Error("ç·¨é›†è¨­å®šã®ä¿å­˜ã«å¤±æ•—");
    }

    async function saveAll() {
      try {
        await Promise.all([saveSubtitles(), saveStyle(), saveAudioTracks(), saveEditSettings()]);
        showToast();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
    }

    async function saveAndOpenStudio() {
      const w = window.open("http://localhost:3000/MyComp", "_blank");
      try {
        await Promise.all([saveSubtitles(), saveStyle(), saveAudioTracks(), saveEditSettings()]);
      } catch (e) { }
      if (w) w.focus();
    }

    // Audio track management
    async function uploadAudioFile(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("audio", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-audio`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
        const data = await res.json();
        audioTracks.push({ filename: data.filename, startTime: 0, volume: 0.5 });
        displayAudioTracks();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
      input.value = '';
    }

    function displayAudioTracks() {
      const list = document.getElementById('audioTrackList');
      list.innerHTML = audioTracks.map((t, i) => `
        <div class="audio-item">
          <span class="audio-name">ğŸµ ${t.filename}</span>
          <label>é–‹å§‹(s)</label>
          <input type="number" value="${t.startTime}" step="0.1" min="0" onchange="audioTracks[${i}].startTime=parseFloat(this.value)">
          <label>éŸ³é‡</label>
          <input type="number" value="${t.volume}" step="0.1" min="0" max="1" onchange="audioTracks[${i}].volume=parseFloat(this.value)">
          <button class="btn-icon btn-delete" onclick="audioTracks.splice(${i},1); displayAudioTracks()" title="å‰Šé™¤">âœ•</button>
        </div>
      `).join('');
    }

    // Edit settings
    function updateEditSettings() {
      const startVal = document.getElementById('trimStart').value;
      const endVal = document.getElementById('trimEnd').value;
      editSettings.trim.startTime = parseFloat(startVal) || 0;
      editSettings.trim.endTime = endVal ? parseFloat(endVal) : null;
      editSettings.transition.fadeIn = parseFloat(document.getElementById('fadeIn').value) || 0;
      editSettings.transition.fadeOut = parseFloat(document.getElementById('fadeOut').value) || 0;
      const speed = parseFloat(document.getElementById('playbackSpeed').value) || 1;
      editSettings.speedSections = [{ start: 0, end: 9999, speed }];
    }

    function setSpeed(speed) {
      document.getElementById('playbackSpeed').value = speed;
      updateEditSettings();
      updateSpeedPresets();
    }

    function updateSpeedPresets() {
      const speed = parseFloat(document.getElementById('playbackSpeed').value);
      document.querySelectorAll('.speed-preset-btn').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.textContent) === speed);
      });
    }

    async function uploadMergeVideo(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("video", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-video`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
        const data = await res.json();
        editSettings.additionalVideos.push(data.filename);
        displayMergeVideos();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
      input.value = '';
    }

    function displayMergeVideos() {
      const list = document.getElementById('mergeVideoList');
      list.innerHTML = editSettings.additionalVideos.map((v, i) => `
        <div class="merge-item">
          <span class="merge-name">ğŸ¬ ${v}</span>
          <button class="btn-icon btn-delete" onclick="editSettings.additionalVideos.splice(${i},1); displayMergeVideos()" title="å‰Šé™¤">âœ•</button>
        </div>
      `).join('');
    }

    // Image overlays
    async function uploadOverlayImage(input) {
      const file = input.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("image", file);
      try {
        const res = await fetch(`${SERVER}/api/upload-image`, {
          method: "POST",
          body: formData,
        });
        if (!res.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
        const data = await res.json();
        editSettings.imageOverlays.push({
          filename: data.filename,
          startTime: 0,
          endTime: 5,
          posX: 50,
          posY: 50,
          width: 200,
          opacity: 1,
          animation: "fadeIn"
        });
        displayOverlays();
      } catch (error) {
        document.getElementById("errorMsg").textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      }
      input.value = '';
    }

    function displayOverlays() {
      const list = document.getElementById('overlayList');
      list.innerHTML = editSettings.imageOverlays.map((o, i) => `
        <div class="overlay-item">
          <span class="overlay-name">ğŸ–¼ï¸ ${o.filename.slice(0, 15)}</span>
          <label>é–‹å§‹</label><input type="number" value="${o.startTime}" step="0.1" min="0" onchange="editSettings.imageOverlays[${i}].startTime=parseFloat(this.value)">
          <label>çµ‚äº†</label><input type="number" value="${o.endTime}" step="0.1" min="0" onchange="editSettings.imageOverlays[${i}].endTime=parseFloat(this.value)">
          <label>X%</label><input type="number" value="${o.posX}" min="0" max="100" onchange="editSettings.imageOverlays[${i}].posX=parseInt(this.value)">
          <label>Y%</label><input type="number" value="${o.posY}" min="0" max="100" onchange="editSettings.imageOverlays[${i}].posY=parseInt(this.value)">
          <label>å¹…</label><input type="number" value="${o.width}" min="10" max="1000" step="10" onchange="editSettings.imageOverlays[${i}].width=parseInt(this.value)">
          <label>é€æ˜åº¦</label><input type="number" value="${o.opacity}" step="0.1" min="0" max="1" onchange="editSettings.imageOverlays[${i}].opacity=parseFloat(this.value)">
          <select onchange="editSettings.imageOverlays[${i}].animation=this.value">
            <option value="none" ${o.animation === 'none' ? 'selected' : ''}>ãªã—</option>
            <option value="fadeIn" ${o.animation === 'fadeIn' ? 'selected' : ''}>ãƒ•ã‚§ãƒ¼ãƒ‰</option>
            <option value="pop" ${o.animation === 'pop' ? 'selected' : ''}>ãƒãƒƒãƒ—</option>
          </select>
          <button class="btn-icon btn-delete" onclick="editSettings.imageOverlays.splice(${i},1); displayOverlays()" title="å‰Šé™¤">âœ•</button>
        </div>
      `).join('');
    }

    // Filters
    function updateFilters() {
      const f = editSettings.filters;
      f.brightness = parseInt(document.getElementById('filterBrightness').value);
      f.contrast = parseInt(document.getElementById('filterContrast').value);
      f.saturate = parseInt(document.getElementById('filterSaturate').value);
      f.sepia = parseInt(document.getElementById('filterSepia').value);
      f.grayscale = parseInt(document.getElementById('filterGrayscale').value);
      f.hueRotate = parseInt(document.getElementById('filterHue').value);
      f.blur = parseFloat(document.getElementById('filterBlur').value);
      // Update labels
      document.getElementById('filterBrightnessVal').textContent = f.brightness + '%';
      document.getElementById('filterContrastVal').textContent = f.contrast + '%';
      document.getElementById('filterSaturateVal').textContent = f.saturate + '%';
      document.getElementById('filterSepiaVal').textContent = f.sepia + '%';
      document.getElementById('filterGrayscaleVal').textContent = f.grayscale + '%';
      document.getElementById('filterHueVal').textContent = f.hueRotate + 'Â°';
      document.getElementById('filterBlurVal').textContent = f.blur + 'px';
      // Apply to preview video
      applyPreviewFilter();
    }

    function resetFilters() {
      document.getElementById('filterBrightness').value = 100;
      document.getElementById('filterContrast').value = 100;
      document.getElementById('filterSaturate').value = 100;
      document.getElementById('filterSepia').value = 0;
      document.getElementById('filterGrayscale').value = 0;
      document.getElementById('filterHue').value = 0;
      document.getElementById('filterBlur').value = 0;
      updateFilters();
    }

    function applyPreviewFilter() {
      const video = document.getElementById('previewVideo');
      if (!video) return;
      const f = editSettings.filters;
      const parts = [];
      if (f.brightness !== 100) parts.push(`brightness(${f.brightness}%)`);
      if (f.contrast !== 100) parts.push(`contrast(${f.contrast}%)`);
      if (f.saturate !== 100) parts.push(`saturate(${f.saturate}%)`);
      if (f.sepia > 0) parts.push(`sepia(${f.sepia}%)`);
      if (f.grayscale > 0) parts.push(`grayscale(${f.grayscale}%)`);
      if (f.hueRotate > 0) parts.push(`hue-rotate(${f.hueRotate}deg)`);
      if (f.blur > 0) parts.push(`blur(${f.blur}px)`);
      video.style.filter = parts.join(' ') || 'none';
    }

    // Ken Burns
    function updateKenBurns() {
      const kb = editSettings.kenBurns;
      kb.enabled = document.getElementById('kbToggle').classList.contains('active');
      kb.startScale = parseFloat(document.getElementById('kbStartScale').value) || 1;
      kb.endScale = parseFloat(document.getElementById('kbEndScale').value) || 1;
      kb.startX = parseFloat(document.getElementById('kbStartX').value) || 0;
      kb.endX = parseFloat(document.getElementById('kbEndX').value) || 0;
      kb.startY = parseFloat(document.getElementById('kbStartY').value) || 0;
      kb.endY = parseFloat(document.getElementById('kbEndY').value) || 0;
      document.getElementById('kbLabel').textContent = kb.enabled ? 'ON' : 'OFF';
      document.getElementById('kbControls').style.display = kb.enabled ? '' : 'none';
    }

    function setKBPreset(ss, es, sx, ex, sy, ey) {
      document.getElementById('kbStartScale').value = ss;
      document.getElementById('kbEndScale').value = es;
      document.getElementById('kbStartX').value = sx;
      document.getElementById('kbEndX').value = ex;
      document.getElementById('kbStartY').value = sy;
      document.getElementById('kbEndY').value = ey;
      if (!document.getElementById('kbToggle').classList.contains('active')) {
        document.getElementById('kbToggle').classList.add('active');
      }
      updateKenBurns();
    }

    // Free Telop
    function addTelop() {
      editSettings.textOverlays.push({
        text: "ãƒ†ãƒ­ãƒƒãƒ—",
        startTime: 0,
        endTime: 5,
        posX: 50,
        posY: 50,
        fontSize: 48,
        fontFamily: "Noto Sans JP",
        fontColor: "#ffffff",
        bgColor: "#000000",
        bgOpacity: 0.7,
        bold: true,
        animation: "fadeIn"
      });
      displayTelops();
    }

    function displayTelops() {
      const fontOptions = Array.from(document.getElementById('styleFont').options)
        .map(o => `<option value="${o.value}">${o.text}</option>`).join('');

      const list = document.getElementById('telopList');
      list.innerHTML = editSettings.textOverlays.map((t, i) => `
        <div class="telop-item">
          <div class="telop-top">
            <input type="text" value="${t.text.replace(/"/g, '&quot;')}" onchange="editSettings.textOverlays[${i}].text=this.value" placeholder="ãƒ†ã‚­ã‚¹ãƒˆ">
            <label>é–‹å§‹</label>
            <input type="number" value="${t.startTime}" step="0.1" min="0" onchange="editSettings.textOverlays[${i}].startTime=parseFloat(this.value)">
            <label>çµ‚äº†</label>
            <input type="number" value="${t.endTime}" step="0.1" min="0" onchange="editSettings.textOverlays[${i}].endTime=parseFloat(this.value)">
            <label>X%</label>
            <input type="number" value="${t.posX}" min="0" max="100" onchange="editSettings.textOverlays[${i}].posX=parseInt(this.value)">
            <label>Y%</label>
            <input type="number" value="${t.posY}" min="0" max="100" onchange="editSettings.textOverlays[${i}].posY=parseInt(this.value)">
            <button class="btn-icon btn-style-toggle" onclick="document.getElementById('telopStyle${i}').classList.toggle('open')" title="ã‚¹ã‚¿ã‚¤ãƒ«">ğŸ¨</button>
            <button class="btn-icon btn-delete" onclick="editSettings.textOverlays.splice(${i},1); displayTelops()" title="å‰Šé™¤">âœ•</button>
          </div>
          <div class="telop-style" id="telopStyle${i}">
            <div class="tsf"><label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
              <select onchange="editSettings.textOverlays[${i}].fontFamily=this.value">
                ${fontOptions}
              </select>
            </div>
            <div class="tsf"><label>ã‚µã‚¤ã‚º</label>
              <input type="number" value="${t.fontSize}" min="12" max="200" onchange="editSettings.textOverlays[${i}].fontSize=parseInt(this.value)">
            </div>
            <div class="tsf"><label>æ–‡å­—</label>
              <input type="color" value="${t.fontColor}" onchange="editSettings.textOverlays[${i}].fontColor=this.value">
            </div>
            <div class="tsf"><label>èƒŒæ™¯</label>
              <input type="color" value="${t.bgColor}" onchange="editSettings.textOverlays[${i}].bgColor=this.value">
            </div>
            <div class="tsf"><label>é€æ˜åº¦</label>
              <input type="number" value="${t.bgOpacity}" step="0.1" min="0" max="1" style="width:45px" onchange="editSettings.textOverlays[${i}].bgOpacity=parseFloat(this.value)">
            </div>
            <div class="tsf"><label>ã‚¢ãƒ‹ãƒ¡</label>
              <select onchange="editSettings.textOverlays[${i}].animation=this.value">
                <option value="none" ${t.animation === 'none' ? 'selected' : ''}>ãªã—</option>
                <option value="fadeIn" ${t.animation === 'fadeIn' ? 'selected' : ''}>ãƒ•ã‚§ãƒ¼ãƒ‰</option>
                <option value="slideUp" ${t.animation === 'slideUp' ? 'selected' : ''}>ã‚¹ãƒ©ã‚¤ãƒ‰</option>
                <option value="pop" ${t.animation === 'pop' ? 'selected' : ''}>ãƒãƒƒãƒ—</option>
                <option value="typewriter" ${t.animation === 'typewriter' ? 'selected' : ''}>ã‚¿ã‚¤ãƒ—</option>
              </select>
            </div>
          </div>
        </div>
      `).join('');

      // ãƒ•ã‚©ãƒ³ãƒˆå€¤å¾©å…ƒ
      editSettings.textOverlays.forEach((t, i) => {
        const sel = document.querySelector(`#telopStyle${i} select`);
        if (sel) sel.value = t.fontFamily;
      });
    }

    // Export: MP4 Render
    async function startRender() {
      const btn = document.getElementById('renderBtn');
      const status = document.getElementById('renderStatus');
      const result = document.getElementById('renderResult');
      btn.disabled = true;
      btn.textContent = '\u23f3 \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d...';
      status.className = 'render-status';
      status.textContent = '\u203b \u8a2d\u5b9a\u3092\u4fdd\u5b58\u4e2d...';
      result.innerHTML = '';
      try {
        // ã‚¹ãƒ†ãƒƒãƒ—1: è¨­å®šä¿å­˜
        try { await saveSubtitles(); } catch (e) { throw new Error('å­—å¹•ä¿å­˜å¤±æ•—: ' + e.message); }
        try { await saveStyle(); } catch (e) { throw new Error('ã‚¹ã‚¿ã‚¤ãƒ«ä¿å­˜å¤±æ•—: ' + e.message); }
        try { await saveAudioTracks(); } catch (e) { throw new Error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªä¿å­˜å¤±æ•—: ' + e.message); }
        try { await saveEditSettings(); } catch (e) { throw new Error('ç·¨é›†è¨­å®šä¿å­˜å¤±æ•—: ' + e.message); }

        // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¸ãƒ§ãƒ–é–‹å§‹
        status.textContent = '\u203b \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u958b\u59cb\u4e2d...';
        const res = await fetch(`${SERVER}/api/render`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: currentFilename }),
        });
        if (!res.ok) {
          const text = await res.text();
          let errMsg;
          try { errMsg = JSON.parse(text).error; } catch { errMsg = text; }
          throw new Error(errMsg || `HTTP ${res.status}`);
        }
        const data = await res.json();
        const jobId = data.jobId;
        if (!jobId) throw new Error('ã‚¸ãƒ§ãƒ–IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');

        // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ãƒªãƒ³ã‚°
        status.textContent = '\u203b FFmpeg\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d... \u6570\u5206\u304b\u304b\u308a\u307e\u3059';
        let dots = 0;
        const pollInterval = setInterval(async () => {
          dots = (dots + 1) % 4;
          status.textContent = '\u203b FFmpeg\u3067\u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u4e2d' + '.'.repeat(dots + 1);
        }, 1000);

        const jobResult = await new Promise((resolve, reject) => {
          const check = async () => {
            try {
              const statusRes = await fetch(`${SERVER}/api/render-status/${jobId}`);
              const job = await statusRes.json();
              if (job.status === 'done') {
                clearInterval(pollInterval);
                resolve(job);
              } else if (job.status === 'error') {
                clearInterval(pollInterval);
                reject(new Error(job.error || 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«å¤±æ•—'));
              } else {
                setTimeout(check, 3000);
              }
            } catch (e) {
              setTimeout(check, 5000);
            }
          };
          setTimeout(check, 3000);
        });

        status.className = 'render-status success';
        status.textContent = '\u2705 \u30ec\u30f3\u30c0\u30ea\u30f3\u30b0\u5b8c\u4e86\uff01';
        result.innerHTML = `<a class="download-link" href="${SERVER}/${jobResult.path}" download="${jobResult.filename}">\u2b07 ${jobResult.filename} \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9</a>`;
      } catch (error) {
        status.className = 'render-status error';
        status.textContent = `\u274c \u30a8\u30e9\u30fc: ${error.message}`;
        console.error('render error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = '\ud83d\udce6 \u52d5\u753b\u3092\u66f8\u304d\u51fa\u3057';
      }
    }

    // Export: SRT/VTT
    async function exportSubtitles() {
      const format = document.getElementById('exportSubFormat').value;
      try {
        const res = await fetch(`${SERVER}/api/export-subtitles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subtitles: currentSubtitles, format }),
        });
        if (!res.ok) throw new Error('\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u5931\u6557');
        const text = await res.text();
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const baseName = currentFilename.replace(/\.[^.]+$/, '');
        a.href = url;
        a.download = `${baseName}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast();
      } catch (error) {
        document.getElementById('errorMsg').textContent = `\u30a8\u30e9\u30fc: ${error.message}`;
      }
    }

    // Export: Thumbnail
    async function generateThumbnail() {
      const time = parseFloat(document.getElementById('thumbTime').value) || 0;
      const result = document.getElementById('thumbResult');
      result.innerHTML = '<div style="color:#888; font-size:12px; margin-top:8px">\u751f\u6210\u4e2d...</div>';
      try {
        const res = await fetch(`${SERVER}/api/thumbnail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: currentFilename, time }),
        });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error); }
        const data = await res.json();
        result.innerHTML = `
          <div class="thumb-preview">
            <img src="${SERVER}/${data.path}?t=${Date.now()}" alt="\u30b5\u30e0\u30cd\u30a4\u30eb">
          </div>
          <a class="download-link" href="${SERVER}/${data.path}" download="${data.filename}">\u2b07 ${data.filename} \u3092\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9</a>
        `;
      } catch (error) {
        result.innerHTML = `<div style="color:#ef4444; font-size:12px; margin-top:8px">\u274c ${error.message}</div>`;
      }
    }

    // Project Save/Load
    function downloadProject() {
      const project = {
        version: 1,
        filename: currentFilename,
        subtitles: currentSubtitles,
        style: currentStyle,
        audioTracks: audioTracks,
        editSettings: editSettings
      };
      const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const baseName = currentFilename ? currentFilename.replace(/\.[^.]+$/, '') : 'project';
      a.href = url;
      a.download = `${baseName}_project.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast();
    }

    function loadProject(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const project = JSON.parse(e.target.result);
          if (project.subtitles) currentSubtitles = project.subtitles;
          if (project.style) currentStyle = project.style;
          if (project.audioTracks) audioTracks = project.audioTracks;
          if (project.editSettings) editSettings = project.editSettings;
          if (project.filename) currentFilename = project.filename;
          takeSnapshot();
          refreshUI();
          showToast();
        } catch (err) {
          document.getElementById('errorMsg').textContent = 'JSON\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557: ' + err.message;
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', function (e) {
      const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (!mod) return;

      if (e.key === 's' || e.key === 'S') {
        e.preventDefault();
        saveAll();
      } else if (e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
        e.preventDefault();
        redo();
      } else if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        downloadProject();
      } else if (e.key === 'o' || e.key === 'O') {
        e.preventDefault();
        document.getElementById('projectFileInput').click();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        saveAndOpenStudio();
      }
    });

    // Wire takeSnapshot into key changes
    const origSaveAll = saveAll;
    saveAll = async function () {
      takeSnapshot();
      return origSaveAll();
    };

    function showToast() {
      const toast = document.getElementById("saveToast");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }
  </script>
</body>

</html>